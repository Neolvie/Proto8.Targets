# –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –ø—Ä–æ—Ç–æ—Ç–∏–ø–∞ v2

**–ê–≥–µ–Ω—Ç:** Architect
**–î–∞—Ç–∞:** 2026-02-19
**–°—Ç–∞—Ç—É—Å:** –ì–æ—Ç–æ–≤–æ
**–í–µ—Ä—Å–∏—è:** 2.0

---

## –†–µ–∑—é–º–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π v1 ‚Üí v2

**–£–¥–∞–ª–µ–Ω–æ –∏–∑ v1:**
- –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–æ–≤ —á–µ—Ä–µ–∑ UI (`/api/upload`, `<input type="file">`)
- –ü–∞—Ä—Å–µ—Ä—ã `json_parser.py`, `docx_parser.py`
- –ü–æ–ª–µ `docx_content` –≤ API-–∑–∞–ø—Ä–æ—Å–∞—Ö

**–î–æ–±–∞–≤–ª–µ–Ω–æ –≤ v2:**
- –ü—Ä—è–º–∞—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å Directum Targets API (4 endpoint'–∞)
- –õ–µ–≤–∞—è –ø–∞–Ω–µ–ª—å –Ω–∞–≤–∏–≥–∞—Ü–∏–∏: —Ñ–∏–ª—å—Ç—Ä –ø–µ—Ä–∏–æ–¥–∞ ‚Üí —Å–ø–∏—Å–æ–∫ –∫–∞—Ä—Ç ‚Üí —Å–ø–∏—Å–æ–∫ —Ü–µ–ª–µ–π
- –ê–¥–∞–ø—Ç–∏–≤–Ω—ã–µ –∫–µ–π—Å—ã (—Ä–µ–∂–∏–º ¬´–ö–∞—Ä—Ç–∞¬ª vs —Ä–µ–∂–∏–º ¬´–¶–µ–ª—å¬ª)
- –ö–Ω–æ–ø–∫–∞ ¬´–ù–æ–≤–∞—è –±–µ—Å–µ–¥–∞¬ª ‚Äî —Å–±—Ä–æ—Å –∏—Å—Ç–æ—Ä–∏–∏ –¥–∏–∞–ª–æ–≥–∞ —Å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
- Session-based –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ API-–æ—Ç–≤–µ—Ç–æ–≤ (in-memory)
- –ö–æ–º–ø–∞–∫—Ç–Ω—ã–π —Ç–µ–∫—Å—Ç–æ–≤—ã–π —Ñ–æ—Ä–º–∞—Ç –¥–ª—è LLM (–≤–º–µ—Å—Ç–æ —Å—ã—Ä–æ–≥–æ JSON)
- –ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è —Ç–µ–∫—Å—Ç–æ–≤—ã—Ö –ø–æ–ª–µ–π (—É–¥–∞–ª–µ–Ω–∏–µ escape-–ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç–µ–π `\n`, `\\`, `\r`)
- –û—Ü–µ–Ω–∫–∞ —Ä–∞–∑–º–µ—Ä–∞ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ —á–µ—Ä–µ–∑ `tiktoken` —Å –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è–º–∏ –ø—Ä–∏ –ø—Ä–µ–≤—ã—à–µ–Ω–∏–∏ –ª–∏–º–∏—Ç–∞
- –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è `TARGETS_BASE_URL`, `TARGETS_TOKEN`

**–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ –∏–∑ v1:**
- 7 –∫–µ–π—Å–æ–≤ OKR-–∞–Ω–∞–ª–∏–∑–∞ (–ª–æ–≥–∏–∫–∞ –ø—Ä–æ–º–ø—Ç–æ–≤ –ø–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è, —Ñ–æ—Ä–º–∞—Ç –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –∞–¥–∞–ø—Ç–∏—Ä—É–µ—Ç—Å—è)
- SSE —Å—Ç—Ä–∏–º–∏–Ω–≥ –æ—Ç–≤–µ—Ç–æ–≤ (`stream_completion`, `readSSEStreamToElement`, `AbortController`)
- –ë—ç–∫-–æ—Ñ–∏—Å —Å –º–µ—Ç—Ä–∏–∫–∞–º–∏ (`/backoffice`, SQLite, `metrics_storage.py`)
- –°–∏—Å—Ç–µ–º–∞ –æ—Ü–µ–Ω–æ–∫ üëç/üëé
- FastAPI + Vanilla JS –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞
- Docker + docker-compose –¥–µ–ø–ª–æ–π
- –ü–æ—Å—Ç—Ä–æ—á–Ω—ã–π `renderMarkdown` –±–µ–∑ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π

---

## –¢–µ—Ö–Ω–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–π —Å—Ç–µ–∫

| –ö–æ–º–ø–æ–Ω–µ–Ω—Ç | –¢–µ—Ö–Ω–æ–ª–æ–≥–∏—è | –û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ |
|-----------|------------|-------------|
| **Backend** | FastAPI 0.115+ | –û–±—è–∑–∞—Ç–µ–ª–µ–Ω –ø–æ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è–º —Å–∏—Å—Ç–µ–º—ã; –≤—Å—Ç—Ä–æ–µ–Ω–Ω–∞—è –ø–æ–¥–¥–µ—Ä–∂–∫–∞ SSE —á–µ—Ä–µ–∑ `StreamingResponse` |
| **Frontend** | Vanilla JS (HTML/CSS/JS) | –û–±—è–∑–∞—Ç–µ–ª–µ–Ω –ø–æ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è–º; –Ω–∏–∫–∞–∫–∏—Ö —Ñ—Ä–µ–π–º–≤–æ—Ä–∫–æ–≤ (React/Vue/Angular –∑–∞–ø—Ä–µ—â–µ–Ω—ã) |
| **LLM API** | OpenAI Python SDK (`AsyncOpenAI`) | –ï–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω—ã–π —Ä–∞–∑—Ä–µ—à–µ–Ω–Ω—ã–π SDK –¥–ª—è LLM-–∑–∞–ø—Ä–æ—Å–æ–≤; –ø–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `llm_service.py` |
| **HTTP-–∫–ª–∏–µ–Ω—Ç** | `httpx` (async) | –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π HTTP-–∫–ª–∏–µ–Ω—Ç –¥–ª—è –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ Targets API |
| **–í–∞–ª–∏–¥–∞—Ü–∏—è** | `pydantic` v2 | –í–∞–ª–∏–¥–∞—Ü–∏—è —Å—Ç—Ä—É–∫—Ç—É—Ä –¥–∞–Ω–Ω—ã—Ö –∏–∑ Targets API |
| **–¢–æ–∫–µ–Ω–∏–∑–∞—Ü–∏—è** | `tiktoken` | –û—Ü–µ–Ω–∫–∞ —Ä–∞–∑–º–µ—Ä–∞ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –ø–µ—Ä–µ–¥ –ø–µ—Ä–µ–¥–∞—á–µ–π –≤ –º–æ–¥–µ–ª—å |
| **–ë–î –º–µ—Ç—Ä–∏–∫** | SQLite | –õ–µ–≥–∫–æ–≤–µ—Å–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ –¥–ª—è –º–µ—Ç—Ä–∏–∫ –±—ç–∫-–æ—Ñ–∏—Å–∞ (–ø–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `metrics_storage.py`) |
| **–¢–µ—Å—Ç—ã: Unit** | `pytest` ‚â•8.0, `pytest-asyncio`, `pytest-cov` | –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã, –ø–æ–∫—Ä—ã—Ç–∏–µ ‚â•70% |
| **–¢–µ—Å—Ç—ã: E2E** | Playwright | E2E-—Ç–µ—Å—Ç—ã –∑–∞–ø—É—Å–∫–∞—é—Ç—Å—è **—Å–Ω–∞—Ä—É–∂–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞** –ø—Ä–æ—Ç–∏–≤ `localhost:8000` |
| **–î–µ–ø–ª–æ–π** | Docker + docker-compose | –û–±—è–∑–∞—Ç–µ–ª–µ–Ω; multi-stage Dockerfile (production –±–µ–∑ Playwright) |
| **–°—Ç–∏–ª–∏** | Directum UI Kit | https://www.directum.ru/ui-kit ‚Äî —Ü–≤–µ—Ç–∞, —à—Ä–∏—Ñ—Ç—ã, –∏–∫–æ–Ω–∫–∏ |

---

## –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —Å–∏—Å—Ç–µ–º—ã

### –°—Ö–µ–º–∞ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤

```mermaid
graph TB
    subgraph "–ë—Ä–∞—É–∑–µ—Ä –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"
        UI[index.html + app.js]
        BO[backoffice.html + backoffice.js]
    end

    subgraph "FastAPI Backend"
        API[main.py - Router]
        TAPI[targets_api.py - HTTP-–∫–ª–∏–µ–Ω—Ç Targets]
        CTX[context_builder.py - –ö–æ–º–ø–∞–∫—Ç–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç]
        CASES[cases_service.py - 7 –∫–µ–π—Å–æ–≤]
        CHAT[chat_service.py - –°–≤–æ–±–æ–¥–Ω—ã–π —á–∞—Ç]
        LLM[llm_service.py - OpenAI SDK]
        METRICS[metrics_storage.py - SQLite]
        CACHE[app.state.cache - In-memory]
    end

    subgraph "–í–Ω–µ—à–Ω–∏–µ —Å–∏—Å—Ç–µ–º—ã"
        TARGETS[Directum Targets API]
        OPENAI[OpenAI API]
    end

    UI -->|GET /| API
    UI -->|GET /api/maps| API
    UI -->|GET /api/maps/:id/goals| API
    UI -->|GET /api/targets/:id| API
    UI -->|POST /api/cases/:id| API
    UI -->|POST /api/chat| API
    UI -->|POST /api/feedback| API

    BO -->|GET /backoffice| API
    BO -->|GET /api/metrics| API

    API --> TAPI
    API --> CTX
    API --> CASES
    API --> CHAT
    API --> METRICS
    API --> CACHE

    TAPI -->|GET, POST| TARGETS
    CASES --> CTX
    CASES --> LLM
    CHAT --> CTX
    CHAT --> LLM
    LLM -->|POST /chat/completions| OPENAI
```

### –ü–æ—Ç–æ–∫ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –∫–µ–π—Å–∞

```mermaid
sequenceDiagram
    participant U as –ë—Ä–∞—É–∑–µ—Ä
    participant API as FastAPI
    participant CACHE as In-memory Cache
    participant TAPI as targets_api.py
    participant CTX as context_builder.py
    participant CASES as cases_service.py
    participant LLM as llm_service.py
    participant OPENAI as OpenAI API

    U->>API: GET /api/targets/725
    API->>CACHE: –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫—ç—à–∞ (session_id)
    alt –ö—ç—à –µ—Å—Ç—å
        CACHE-->>API: –î–∞–Ω–Ω—ã–µ –∏–∑ –∫—ç—à–∞
    else –ö—ç—à–∞ –Ω–µ—Ç
        API->>TAPI: get_target(725)
        TAPI->>TARGETS: GET /ITargetsTargets(725)
        TARGETS-->>TAPI: JSON target
        TAPI->>TAPI: –í–∞–ª–∏–¥–∞—Ü–∏—è —á–µ—Ä–µ–∑ Pydantic
        TAPI-->>API: TargetDetail
        API->>TAPI: get_key_results(725)
        TAPI->>TARGETS: GET /GetKeyResults(725)
        TARGETS-->>TAPI: JSON KRs
        TAPI-->>API: List[KeyResult]
        API->>CACHE: –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ –∫—ç—à
    end
    API-->>U: JSON {target, key_results}

    U->>API: POST /api/cases/1 {target_id: 725}
    API->>CASES: run_case(1, target_id)
    CASES->>CACHE: –ü–æ–ª—É—á–∏—Ç—å target + KRs –∏–∑ –∫—ç—à–∞
    CASES->>CTX: build_target_context(target, krs)
    CTX->>CTX: normalize_text(), estimate_tokens()
    CTX-->>CASES: –ö–æ–º–ø–∞–∫—Ç–Ω—ã–π —Ç–µ–∫—Å—Ç ~2-3 KB
    CASES->>LLM: stream_completion(messages)
    LLM->>OPENAI: POST /chat/completions (stream=True)

    loop SSE Stream
        OPENAI-->>LLM: Chunk
        LLM-->>CASES: Chunk
        CASES-->>API: yield chunk
        API-->>U: data: "chunk"\n\n
    end

    OPENAI-->>LLM: [DONE]
    LLM-->>CASES: [DONE]
    CASES-->>API: yield [DONE]
    API-->>U: data: [DONE]\n\n
```

---

## –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞

```
Proto8.Targets/
‚îú‚îÄ‚îÄ .hypothesis/
‚îÇ   ‚îú‚îÄ‚îÄ v2_01_REQUIREMENTS.md     ‚Üê BA output
‚îÇ   ‚îî‚îÄ‚îÄ v2_02_ARCHITECTURE.md     ‚Üê —ç—Ç–æ—Ç —Ñ–∞–π–ª
‚îú‚îÄ‚îÄ new_hypothesis/
‚îÇ   ‚îú‚îÄ‚îÄ 001_HYPOTHESIS.md         ‚Üê –∏—Å—Ö–æ–¥–Ω–∞—è –≥–∏–ø–æ—Ç–µ–∑–∞
‚îÇ   ‚îú‚îÄ‚îÄ maps.json                 ‚Üê –ø—Ä–∏–º–µ—Ä API –æ—Ç–≤–µ—Ç–∞
‚îÇ   ‚îú‚îÄ‚îÄ map.json                  ‚Üê –ø—Ä–∏–º–µ—Ä –≥—Ä–∞—Ñ–∞ —Ü–µ–ª–µ–π
‚îÇ   ‚îú‚îÄ‚îÄ target.json               ‚Üê –ø—Ä–∏–º–µ—Ä —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω–æ–π —Ü–µ–ª–∏
‚îÇ   ‚îî‚îÄ‚îÄ key_result.json           ‚Üê –ø—Ä–∏–º–µ—Ä –ö–†
‚îú‚îÄ‚îÄ src/
‚îÇ   ‚îú‚îÄ‚îÄ main.py                   ‚Üê FastAPI app, —Ä–æ—É—Ç–µ—Ä—ã
‚îÇ   ‚îú‚îÄ‚îÄ config.py                 ‚Üê –ó–∞–≥—Ä—É–∑–∫–∞ .env (TARGETS_BASE_URL, TARGETS_TOKEN, OPENAI_*)
‚îÇ   ‚îú‚îÄ‚îÄ models/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ targets.py            ‚Üê Pydantic –º–æ–¥–µ–ª–∏ –¥–ª—è Targets API
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ api.py                ‚Üê Pydantic —Å—Ö–µ–º—ã FastAPI endpoints
‚îÇ   ‚îú‚îÄ‚îÄ services/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ targets_api.py        ‚Üê NEW: HTTP-–∫–ª–∏–µ–Ω—Ç –¥–ª—è Targets API
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ context_builder.py    ‚Üê NEW: –ö–æ–º–ø–∞–∫—Ç–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –¥–ª—è LLM
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ cases_service.py      ‚Üê MODIFIED: –∞–¥–∞–ø—Ç–∏—Ä–æ–≤–∞–Ω –ø–æ–¥ –Ω–æ–≤—ã–π –∫–æ–Ω—Ç–µ–∫—Å—Ç
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ chat_service.py       ‚Üê MODIFIED: –∞–¥–∞–ø—Ç–∏—Ä–æ–≤–∞–Ω –ø–æ–¥ –Ω–æ–≤—ã–π –∫–æ–Ω—Ç–µ–∫—Å—Ç
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ llm_service.py        ‚Üê REUSED: stream_completion as-is
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ metrics_storage.py    ‚Üê REUSED: SQLite –º–µ—Ç—Ä–∏–∫–∏ as-is
‚îÇ   ‚îî‚îÄ‚îÄ static/
‚îÇ       ‚îú‚îÄ‚îÄ index.html            ‚Üê MODIFIED: –ª–µ–≤–∞—è –ø–∞–Ω–µ–ª—å + –∞–¥–∞–ø—Ç–∏–≤–Ω—ã–µ –∫–µ–π—Å—ã
‚îÇ       ‚îú‚îÄ‚îÄ app.js                ‚Üê MODIFIED: –Ω–∞–≤–∏–≥–∞—Ü–∏—è, –∫—ç—à —Å–µ—Å—Å–∏–∏, —Ñ–∏–ª—å—Ç—Ä –ø–µ—Ä–∏–æ–¥–∞
‚îÇ       ‚îú‚îÄ‚îÄ style.css             ‚Üê EXTENDED: –¥–≤—É—Ö–∫–æ–ª–æ–Ω–æ—á–Ω—ã–π layout
‚îÇ       ‚îú‚îÄ‚îÄ backoffice.html       ‚Üê REUSED: —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –º–µ—Ç—Ä–∏–∫
‚îÇ       ‚îî‚îÄ‚îÄ backoffice.js         ‚Üê REUSED: Charts.js (–ª–æ–∫–∞–ª—å–Ω–∞—è –∫–æ–ø–∏—è!)
‚îú‚îÄ‚îÄ tests/
‚îÇ   ‚îú‚îÄ‚îÄ unit/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ test_targets_api.py   ‚Üê NEW: –º–æ–∫–∏ httpx
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ test_context_builder.py ‚Üê NEW: —Ç–µ—Å—Ç—ã —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ test_cases_service.py ‚Üê MODIFIED: –∞–¥–∞–ø—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–æ–¥ –Ω–æ–≤—ã–π —Ñ–æ—Ä–º–∞—Ç
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ test_metrics.py       ‚Üê REUSED
‚îÇ   ‚îî‚îÄ‚îÄ e2e/
‚îÇ       ‚îî‚îÄ‚îÄ test_ui_flow.py       ‚Üê MODIFIED: –Ω–æ–≤–∞—è –Ω–∞–≤–∏–≥–∞—Ü–∏—è
‚îú‚îÄ‚îÄ Dockerfile                    ‚Üê MODIFIED: multi-stage (production / test)
‚îú‚îÄ‚îÄ docker-compose.yml            ‚Üê MODIFIED: env_file + volumes
‚îú‚îÄ‚îÄ requirements.txt              ‚Üê ADD: httpx, tiktoken
‚îú‚îÄ‚îÄ pytest.ini
‚îú‚îÄ‚îÄ .coveragerc
‚îú‚îÄ‚îÄ .env.example                  ‚Üê ADD: TARGETS_BASE_URL, TARGETS_TOKEN
‚îî‚îÄ‚îÄ README.md
```

---

## –ù–æ–≤—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã

### 1. `src/services/targets_api.py`

**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π HTTP-–∫–ª–∏–µ–Ω—Ç –¥–ª—è Directum Targets API.

**–û—Å–Ω–æ–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏:**

```python
async def get_maps() -> List[TargetsMap]:
    """
    –ó–∞–≥—Ä—É–∂–∞–µ—Ç —Å–ø–∏—Å–æ–∫ –∫–∞—Ä—Ç —Ü–µ–ª–µ–π.
    GET {TARGETS_BASE_URL}/Integration/odata/ITargetsTargetsMaps
    Authorization: Bearer {TARGETS_TOKEN}

    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç: List[TargetsMap] —Å –ø–æ–ª—è–º–∏ Id, Name, Code, PeriodLabel,
                AchievementPercentage, Status
    –§–∏–ª—å—Ç—Ä—É–µ—Ç: —Ç–æ–ª—å–∫–æ –ø–æ–ª—è –∏–∑ FR-02 (—É–¥–∞–ª—è–µ—Ç @odata.context, —Å–ª—É–∂–µ–±–Ω—ã–µ)
    """

async def get_map_graph(map_id: int) -> MapGraph:
    """
    –ó–∞–≥—Ä—É–∂–∞–µ—Ç –≥—Ä–∞—Ñ —Ü–µ–ª–µ–π –∫–∞—Ä—Ç—ã.
    POST {TARGETS_BASE_URL}/integration/odata/Targets/GetGoalsMap
    Body: {"mapId": map_id}

    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç: MapGraph —Å –ø–æ–ª—è–º–∏ Nodes (—Å–ø–∏—Å–æ–∫ GoalNode), Map
    –ö–∞–∂–¥—ã–π GoalNode —Å–æ–¥–µ—Ä–∂–∏—Ç: TargetId, Code, Name, ParentId, ChildIds,
                               Priority, Progress, KeyResultCount,
                               Status, Responsible, StructuralUnit, Period,
                               LastAchievementStatus
    """

async def get_target(target_id: int) -> TargetDetail:
    """
    –ó–∞–≥—Ä—É–∂–∞–µ—Ç —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –ø–æ —Ü–µ–ª–∏.
    GET {TARGETS_BASE_URL}/Integration/odata/ITargetsTargets({target_id})

    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç: TargetDetail —Å –ø–æ–ª—è–º–∏ Id, Name, Code, StatusDescription,
                PeriodLabel, AchievementPercentage, PeriodStart, PeriodEnd,
                IsPersonal, Description, Notes, Priority
    """

async def get_key_results(target_id: int) -> List[KeyResult]:
    """
    –ó–∞–≥—Ä—É–∂–∞–µ—Ç –∫–ª—é—á–µ–≤—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ü–µ–ª–∏.
    GET {TARGETS_BASE_URL}/integration/odata/Targets/GetKeyResults(targetId={target_id})

    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç: List[KeyResult] —Å –ø–æ–ª—è–º–∏ Description, AchievementPercentage,
                Metric, InitialValue, PlannedValue, ActualValue
    """
```

**–û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫:**

- `401 Unauthorized` ‚Üí raise `HTTPException(401, "Bearer-—Ç–æ–∫–µ–Ω –∏—Å—Ç—ë–∫. –û–±–Ω–æ–≤–∏—Ç–µ TARGETS_TOKEN –≤ .env –∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ")
- `403 Forbidden` ‚Üí raise `HTTPException(403, "–î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â—ë–Ω. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø—Ä–∞–≤–∞ —Ç–æ–∫–µ–Ω–∞")
- `404 Not Found` ‚Üí raise `HTTPException(404, "–ö–∞—Ä—Ç–∞/—Ü–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω–∞")
- `500 Server Error` ‚Üí raise `HTTPException(500, "–û—à–∏–±–∫–∞ API Targets: ...")
- `Timeout` ‚Üí raise `HTTPException(504, "–¢–∞–π–º–∞—É—Ç API Targets. –ü–æ–≤—Ç–æ—Ä–∏—Ç–µ –∑–∞–ø—Ä–æ—Å")

**Pydantic –º–æ–¥–µ–ª–∏:** –í—Å–µ –æ—Ç–≤–µ—Ç—ã –≤–∞–ª–∏–¥–∏—Ä—É—é—Ç—Å—è —á–µ—Ä–µ–∑ –º–æ–¥–µ–ª–∏ –∏–∑ `src/models/targets.py`.

---

### 2. `src/services/context_builder.py`

**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –ü—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ JSON –∏–∑ Targets API –≤ –∫–æ–º–ø–∞–∫—Ç–Ω—ã–π —Ç–µ–∫—Å—Ç–æ–≤—ã–π —Ñ–æ—Ä–º–∞—Ç –¥–ª—è –ø–µ—Ä–µ–¥–∞—á–∏ –≤ LLM.

**–û—Å–Ω–æ–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏:**

```python
def build_map_context(nodes: List[GoalNode], map_info: TargetsMap) -> str:
    """
    –§–æ—Ä–º–∏—Ä—É–µ—Ç –∫–æ–º–ø–∞–∫—Ç–Ω—ã–π —Ç–µ–∫—Å—Ç–æ–≤—ã–π –∫–æ–Ω—Ç–µ–∫—Å—Ç –∫–∞—Ä—Ç—ã —Ü–µ–ª–µ–π.

    –§–æ—Ä–º–∞—Ç (FR-16):
    –ö–∞—Ä—Ç–∞ —Ü–µ–ª–µ–π: {Name} | –ü–µ—Ä–∏–æ–¥: {PeriodLabel} | –ü—Ä–æ–≥—Ä–µ—Å—Å: {AchievementPercentage}%

    [{Code}] {Name}
      –û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π: {Responsible.Name} | –ü–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ: {StructuralUnit.Name}
      –ü–µ—Ä–∏–æ–¥: {Period.Name} | –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç: {Priority} | –ü—Ä–æ–≥—Ä–µ—Å—Å: {Progress}% | –ö–†: {KeyResultCount}
      –°—Ç–∞—Ç—É—Å: {Status.Name} {Status.Icon}
      –î–æ—á–µ—Ä–Ω–∏–µ: {ChildIds -> Code, Name —á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é}
      –û—Ç—á—ë—Ç ({ReportDate}): {LastAchievementStatus.Description}
    ---

    –î–ª—è –∫–∞–∂–¥–æ–π —Ü–µ–ª–∏ ‚Äî 6-8 —Å—Ç—Ä–æ–∫.
    –ü—Ä–∏–º–µ–Ω—è–µ—Ç normalize_text() –∫ Description, Notes, LastAchievementStatus.
    """

def build_target_context(target: TargetDetail, key_results: List[KeyResult]) -> str:
    """
    –§–æ—Ä–º–∏—Ä—É–µ—Ç –∫–æ–º–ø–∞–∫—Ç–Ω—ã–π —Ç–µ–∫—Å—Ç–æ–≤—ã–π –∫–æ–Ω—Ç–µ–∫—Å—Ç —Ü–µ–ª–∏.

    –§–æ—Ä–º–∞—Ç (FR-17):
    –¶–µ–ª—å: [{Code}] {Name}
    –ü–µ—Ä–∏–æ–¥: {PeriodLabel} ({PeriodStart} ‚Äî {PeriodEnd})
    –°—Ç–∞—Ç—É—Å: {StatusDescription} | –ü—Ä–æ–≥—Ä–µ—Å—Å: {AchievementPercentage}% | –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç: {Priority}

    –û–ø–∏—Å–∞–Ω–∏–µ:
    {Description}

    –ó–∞–º–µ—Ç–∫–∏ —Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤–∞:
    {Notes}

    –ö–ª—é—á–µ–≤—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã:
    - {Description}: {AchievementPercentage}%
      (–ú–µ—Ç—Ä–∏–∫–∞: {Metric} | –ù–∞—á: {InitialValue} | –ü–ª–∞–Ω: {PlannedValue} | –§–∞–∫—Ç: {ActualValue})

    –ü—Ä–∏–º–µ–Ω—è–µ—Ç normalize_text() –∫ Description, Notes.
    """

def normalize_text(text: str) -> str:
    """
    –£–¥–∞–ª—è–µ—Ç escape-–ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –∏–∑ —Ç–µ–∫—Å—Ç–æ–≤—ã—Ö –ø–æ–ª–µ–π.

    –ó–∞–º–µ–Ω—ã:
    - \\n ‚Üí \n (—Ä–µ–∞–ª—å–Ω—ã–π –ø–µ—Ä–µ–Ω–æ—Å)
    - \\\\ ‚Üí \ (–æ–¥–∏–Ω–∞—Ä–Ω—ã–π —Å–ª–µ—à)
    - \\r ‚Üí (—É–¥–∞–ª–∏—Ç—å)
    - –î—Ä—É–≥–∏–µ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç—ã —ç–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –ø–æ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏

    –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è Description, Notes, LastAchievementStatus.Description.
    """

def estimate_tokens(text: str, model: str = "gpt-4o") -> int:
    """
    –û—Ü–µ–Ω–∏–≤–∞–µ—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç–æ–∫–µ–Ω–æ–≤ –≤ —Ç–µ–∫—Å—Ç–µ —á–µ—Ä–µ–∑ tiktoken.

    –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ä–∞–∑–º–µ—Ä–∞ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –ø–µ—Ä–µ–¥ –ø–µ—Ä–µ–¥–∞—á–µ–π –≤ –º–æ–¥–µ–ª—å.
    –ï—Å–ª–∏ —Ç–æ–∫–µ–Ω–æ–≤ > CONTEXT_LIMIT (–Ω–∞–ø—Ä–∏–º–µ—Ä 100k –¥–ª—è gpt-4o),
    –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é.
    """
```

**–ü—Ä–∏–º–µ—Ä –≤—ã–≤–æ–¥–∞ `build_map_context` (—Ñ—Ä–∞–≥–º–µ–Ω—Ç):**

```
–ö–∞—Ä—Ç–∞ —Ü–µ–ª–µ–π: –¶–µ–ª–∏ –Ω–∞ 2026. –†–∞–∑—Ä–∞–±–æ—Ç–∫–∞ Ario | –ü–µ—Ä–∏–æ–¥: 2026 | –ü—Ä–æ–≥—Ä–µ—Å—Å: 31.0%

[U-26.4.1] –ó–∞–ø—É—Å—Ç–∏—Ç—å –ò–ò-–ø–æ–º–æ—â–Ω–∏–∫–∞ –≤ –ø—Ä–æ–º—ã—à–ª–µ–Ω–Ω—É—é —ç–∫—Å–ø–ª—É–∞—Ç–∞—Ü–∏—é —É –∫–ª–∏–µ–Ω—Ç–æ–≤
  –û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π: –ë–µ–ª—è–∫ –ò–≥–æ—Ä—å –°–µ—Ä–≥–µ–µ–≤–∏—á | –ü–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ: –ë–ï Ario
  –ü–µ—Ä–∏–æ–¥: 2026 –≥–æ–¥ | –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç: Medium | –ü—Ä–æ–≥—Ä–µ—Å—Å: 5.63% | –ö–†: 4
  –°—Ç–∞—Ç—É—Å: –í —Ä–∞–±–æ—Ç–µ: –ï—Å—Ç—å —É–≥—Ä–æ–∑–∞ –Ω–µ–¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è Yellow
  –î–æ—á–µ—Ä–Ω–∏–µ: U-1Q26.1-2, U-4Q25.1.4, U-4Q25.1.5
  –û—Ç—á—ë—Ç (2026-01-15): –ù–∞ –¥–∞–Ω–Ω—ã–π –º–æ–º–µ–Ω—Ç –∏–∑ —Ñ–∏—á –ò–ò-–ø–æ–º–æ—â–Ω–∏–∫–∞ –¥–ª—è –∫–ª–∏–µ–Ω—Ç–æ–≤ –¥–æ—Å—Ç—É–ø–Ω—ã —Ç–æ–ª—å–∫–æ —Å–≤–æ–±–æ–¥–Ω–æ–µ –æ–±—â–µ–Ω–∏–µ –∏ –°–µ—Ä–≤–∏—Å—ã –∫–æ–º–ø–∞–Ω–∏–∏ (ESM).
–ü–µ—Ä–≤–∞—è —Ñ–∏—á–∞ –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –ø—Ä–æ—Å—Ç–∞—è –∏ –±–æ–ª—å—à–æ–π —Ü–µ–Ω–Ω–æ—Å—Ç–∏ –Ω–µ –Ω–µ—Å–µ—Ç...
---

[U-26.4.2] –£—Å–∏–ª–∏—Ç—å —Ä–æ–ª—å –¶–µ–Ω—Ç—Ä–∞ –∫–æ–º–ø–µ—Ç–µ–Ω—Ü–∏–π –ø–æ –ò–ò –∫–∞–∫ –¥—Ä–∞–π–≤–µ—Ä–∞ –≤—Å—Ç—Ä–∞–∏–≤–∞–Ω–∏—è –ò–ò –≤ –ø—Ä–æ–¥—É–∫—Ç—ã –∏ –ø—Ä–æ—Ü–µ—Å—Å—ã
  –û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π: –ë–µ–ª—è–∫ –ò–≥–æ—Ä—å –°–µ—Ä–≥–µ–µ–≤–∏—á | –ü–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ: –ë–ï Ario
  –ü–µ—Ä–∏–æ–¥: 2026 –≥–æ–¥ | –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç: Medium | –ü—Ä–æ–≥—Ä–µ—Å—Å: 12.54% | –ö–†: 5
  –°—Ç–∞—Ç—É—Å: –í —Ä–∞–±–æ—Ç–µ: –ò–¥–µ—Ç –ø–æ –ø–ª–∞–Ω—É Green
  –î–æ—á–µ—Ä–Ω–∏–µ: ‚Äî
  –û—Ç—á—ë—Ç (2026-01-15): –†–µ–∑—É–ª—å—Ç–∞—Ç 1: DAU (–∞–∫—Ç–∏–≤–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –≤ –¥–µ–Ω—å) –≤ —Ä–∞–º–∫–∞—Ö —ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç–∞ –ø–æ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ 30...
---
```

**–û—Ü–µ–Ω–∫–∞ —Ä–∞–∑–º–µ—Ä–∞:**
- –ö–∞—Ä—Ç–∞ –∏–∑ 20 —Ü–µ–ª–µ–π ‚Üí ~15-20 KB —Ç–µ–∫—Å—Ç–∞ ‚Üí ~4-5k —Ç–æ–∫–µ–Ω–æ–≤
- –ö–∞—Ä—Ç–∞ –∏–∑ 100 —Ü–µ–ª–µ–π ‚Üí ~80-100 KB —Ç–µ–∫—Å—Ç–∞ ‚Üí ~20-25k —Ç–æ–∫–µ–Ω–æ–≤
- –ö–∞—Ä—Ç–∞ –∏–∑ 300 —Ü–µ–ª–µ–π ‚Üí ~250 KB —Ç–µ–∫—Å—Ç–∞ ‚Üí ~60-70k —Ç–æ–∫–µ–Ω–æ–≤ (–±–ª–∏–∑–∫–æ –∫ –ª–∏–º–∏—Ç—É gpt-4o 128k)

---

### 3. Session Cache (In-memory)

**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö API –Ω–∞ –≤—Ä–µ–º—è —Å–µ—Å—Å–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.

**–†–µ–∞–ª–∏–∑–∞—Ü–∏—è:** –°–ª–æ–≤–∞—Ä—å –≤ `app.state.cache` (FastAPI):

```python
# –í main.py –ø—Ä–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏
app.state.cache = {}

# –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –∫—ç—à–∞:
{
  "session_id": {
    "maps": List[TargetsMap],           # –°–ø–∏—Å–æ–∫ –∫–∞—Ä—Ç (–Ω–∞ –≤—Å—é —Å–µ—Å—Å–∏—é)
    "map_graph": {
      map_id: MapGraph                   # –ì—Ä–∞—Ñ —Ü–µ–ª–µ–π –∫–∞—Ä—Ç—ã
    },
    "targets": {
      target_id: {
        "detail": TargetDetail,          # –†–∞—Å—à–∏—Ä–µ–Ω–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
        "key_results": List[KeyResult]   # –ö–†
      }
    }
  }
}
```

**–õ–æ–≥–∏–∫–∞ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è:**

- **–°–ø–∏—Å–æ–∫ –∫–∞—Ä—Ç:** –ó–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –æ–±—Ä–∞—â–µ–Ω–∏–∏ –∫ `/api/maps`, –∫—ç—à–∏—Ä—É–µ—Ç—Å—è –Ω–∞ –≤—Å—é —Å–µ—Å—Å–∏—é
- **–ì—Ä–∞—Ñ –∫–∞—Ä—Ç—ã:** –ó–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è –ø—Ä–∏ –≤—ã–±–æ—Ä–µ –∫–∞—Ä—Ç—ã –≤ UI (`/api/maps/{map_id}/goals`), –∫—ç—à–∏—Ä—É–µ—Ç—Å—è –¥–æ —Å–º–µ–Ω—ã –∫–∞—Ä—Ç—ã
- **–¶–µ–ª—å + –ö–†:** –ó–∞–≥—Ä—É–∂–∞—é—Ç—Å—è –ø—Ä–∏ –≤—ã–±–æ—Ä–µ —Ü–µ–ª–∏ –≤ UI (`/api/targets/{target_id}`), –∫—ç—à–∏—Ä—É—é—Ç—Å—è –¥–æ —Å–º–µ–Ω—ã —Ü–µ–ª–∏

**Session ID:** –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è –Ω–∞ —Ñ—Ä–æ–Ω—Ç–µ —á–µ—Ä–µ–∑ `sessionStorage`, –ø–µ—Ä–µ–¥–∞—ë—Ç—Å—è –≤ –∑–∞–≥–æ–ª–æ–≤–∫–µ `X-Session-Id`.

**–ò–Ω–≤–∞–ª–∏–¥–∞—Ü–∏—è:** –ü—Ä–∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è (in-memory —Å–ª–æ–≤–∞—Ä—å –æ—á–∏—â–∞–µ—Ç—Å—è). –î–ª—è production –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å TTL –∏–ª–∏ Redis, –Ω–æ –¥–ª—è –ø—Ä–æ—Ç–æ—Ç–∏–ø–∞ in-memory –¥–æ—Å—Ç–∞—Ç–æ—á–µ–Ω.

---

## API Endpoints

### GET `/`

**–û–ø–∏—Å–∞–Ω–∏–µ:** –ì–ª–∞–≤–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è.

**–û—Ç–≤–µ—Ç:** `index.html`

---

### GET `/backoffice`

**–û–ø–∏—Å–∞–Ω–∏–µ:** –°—Ç—Ä–∞–Ω–∏—Ü–∞ –º–µ—Ç—Ä–∏–∫ –±—ç–∫-–æ—Ñ–∏—Å–∞.

**–û—Ç–≤–µ—Ç:** `backoffice.html`

---

### GET `/api/maps`

**–û–ø–∏—Å–∞–Ω–∏–µ:** –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–ø–∏—Å–æ–∫ –∫–∞—Ä—Ç —Ü–µ–ª–µ–π —Å —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–µ–π –ø–æ –ø–µ—Ä–∏–æ–¥—É (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ).

**Query params:**
- `period` (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ) ‚Äî –∑–Ω–∞—á–µ–Ω–∏–µ `PeriodLabel` –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏

**–õ–æ–≥–∏–∫–∞:**
1. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∫—ç—à –ø–æ `session_id`
2. –ï—Å–ª–∏ –∫—ç—à–∞ –Ω–µ—Ç ‚Üí –≤—ã–∑–≤–∞—Ç—å `targets_api.get_maps()`, —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤ –∫—ç—à
3. –ï—Å–ª–∏ `period` —É–∫–∞–∑–∞–Ω ‚Üí —Ñ–∏–ª—å—Ç—Ä–æ–≤–∞—Ç—å –ø–æ `PeriodLabel == period`
4. –í–µ—Ä–Ω—É—Ç—å —Å–ø–∏—Å–æ–∫ –∫–∞—Ä—Ç —Å –ø–æ–ª—è–º–∏: `Id, Name, Code, PeriodLabel, AchievementPercentage, Status`

**–û—Ç–≤–µ—Ç:**
```json
{
  "maps": [
    {
      "id": 15,
      "name": "–¶–µ–ª–∏ –Ω–∞ 2026. –†–∞–∑—Ä–∞–±–æ—Ç–∫–∞ Ario",
      "code": "U-26.4",
      "period_label": "2026",
      "achievement_percentage": 31.0,
      "status": "Active"
    }
  ],
  "periods": ["2026", "1 –∫–≤–∞—Ä—Ç–∞–ª 2026", "4 –∫–≤–∞—Ä—Ç–∞–ª 2025"]
}
```

---

### GET `/api/maps/{map_id}/goals`

**–û–ø–∏—Å–∞–Ω–∏–µ:** –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –≥—Ä–∞—Ñ —Ü–µ–ª–µ–π –∫–∞—Ä—Ç—ã (—Å–ø–∏—Å–æ–∫ —É–∑–ª–æ–≤).

**Path params:**
- `map_id` ‚Äî ID –∫–∞—Ä—Ç—ã

**–õ–æ–≥–∏–∫–∞:**
1. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∫—ç—à –ø–æ `session_id` ‚Üí `map_graph[map_id]`
2. –ï—Å–ª–∏ –∫—ç—à–∞ –Ω–µ—Ç ‚Üí –≤—ã–∑–≤–∞—Ç—å `targets_api.get_map_graph(map_id)`, —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤ –∫—ç—à
3. –í–µ—Ä–Ω—É—Ç—å —Å–ø–∏—Å–æ–∫ —É–∑–ª–æ–≤

**–û—Ç–≤–µ—Ç:**
```json
{
  "map": {
    "id": 15,
    "name": "–¶–µ–ª–∏ –Ω–∞ 2026. –†–∞–∑—Ä–∞–±–æ—Ç–∫–∞ Ario",
    "progress": 31.0
  },
  "nodes": [
    {
      "target_id": 36,
      "code": "U-26.4.1",
      "name": "–ó–∞–ø—É—Å—Ç–∏—Ç—å –ò–ò-–ø–æ–º–æ—â–Ω–∏–∫–∞ –≤ –ø—Ä–æ–º—ã—à–ª–µ–Ω–Ω—É—é —ç–∫—Å–ø–ª—É–∞—Ç–∞—Ü–∏—é —É –∫–ª–∏–µ–Ω—Ç–æ–≤",
      "progress": 5.63,
      "status_name": "–í —Ä–∞–±–æ—Ç–µ: –ï—Å—Ç—å —É–≥—Ä–æ–∑–∞ –Ω–µ–¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è",
      "status_icon": "Yellow",
      "priority": "Medium",
      "responsible_name": "–ë–µ–ª—è–∫ –ò–≥–æ—Ä—å –°–µ—Ä–≥–µ–µ–≤–∏—á",
      "period_name": "2026 –≥–æ–¥",
      "key_result_count": 4
    }
  ]
}
```

---

### GET `/api/targets/{target_id}`

**–û–ø–∏—Å–∞–Ω–∏–µ:** –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –ø–æ —Ü–µ–ª–∏ + –∫–ª—é—á–µ–≤—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã.

**Path params:**
- `target_id` ‚Äî ID —Ü–µ–ª–∏

**–õ–æ–≥–∏–∫–∞:**
1. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∫—ç—à –ø–æ `session_id` ‚Üí `targets[target_id]`
2. –ï—Å–ª–∏ –∫—ç—à–∞ –Ω–µ—Ç:
   - –í—ã–∑–≤–∞—Ç—å `targets_api.get_target(target_id)`
   - –í—ã–∑–≤–∞—Ç—å `targets_api.get_key_results(target_id)`
   - –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤ –∫—ç—à
3. –í–µ—Ä–Ω—É—Ç—å –¥–∞–Ω–Ω—ã–µ

**–û—Ç–≤–µ—Ç:**
```json
{
  "target": {
    "id": 97,
    "name": "–£—Å–∏–ª–∏—Ç—å —Ä–æ–ª—å –¶–µ–Ω—Ç—Ä–∞ –∫–æ–º–ø–µ—Ç–µ–Ω—Ü–∏–π –ø–æ –ò–ò...",
    "code": "U-26.4.2",
    "status_description": "–í —Ä–∞–±–æ—Ç–µ: –ò–¥–µ—Ç –ø–æ –ø–ª–∞–Ω—É",
    "period_label": "2026",
    "achievement_percentage": 12.54,
    "period_start": "2025-10-01T00:00:00+04:00",
    "period_end": "2026-09-30T00:00:00+04:00",
    "is_personal": false,
    "description": "–í —Ä–∞–º–∫–∞—Ö —ç—Ç–æ–π —Ü–µ–ª–∏ –≤—ã–¥–µ–ª—è—é—Ç—Å—è —Ç—Ä–∏ –∫–ª—é—á–µ–≤—ã—Ö –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è...",
    "notes": null,
    "priority": "Medium"
  },
  "key_results": [
    {
      "description": "–í—ã–¥–µ–ª–µ–Ω–∞ –∏ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∏—Ä—É–µ—Ç –¥–æ–ª–∂–Ω–æ—Å—Ç—å CPO",
      "achievement_percentage": "100",
      "metric": null,
      "initial_value": null,
      "planned_value": null,
      "actual_value": null
    }
  ]
}
```

---

### POST `/api/cases/{case_id}`

**–û–ø–∏—Å–∞–Ω–∏–µ:** –ó–∞–ø—É—Å–∫–∞–µ—Ç –æ–¥–∏–Ω –∏–∑ 7 –∫–µ–π—Å–æ–≤ OKR-–∞–Ω–∞–ª–∏–∑–∞ —Å –ø–æ—Ç–æ–∫–æ–≤—ã–º –æ—Ç–≤–µ—Ç–æ–º (SSE).

**Path params:**
- `case_id` ‚Äî 1-7

**Body:**
```json
{
  "mode": "map" | "target",
  "map_id": 15,              // –û–±—è–∑–∞—Ç–µ–ª–µ–Ω –¥–ª—è —Ä–µ–∂–∏–º–∞ "map"
  "target_id": 97,           // –û–±—è–∑–∞—Ç–µ–ª–µ–Ω –¥–ª—è —Ä–µ–∂–∏–º–∞ "target"
  "session_id": "sess_..."   // Session ID –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ –∫—ç—à—É
}
```

**–õ–æ–≥–∏–∫–∞:**
1. –û–ø—Ä–µ–¥–µ–ª–∏—Ç—å —Ä–µ–∂–∏–º (map/target)
2. –ó–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –∏–∑ –∫—ç—à–∞:
   - –î–ª—è —Ä–µ–∂–∏–º–∞ "map": `map_graph[map_id]`
   - –î–ª—è —Ä–µ–∂–∏–º–∞ "target": `targets[target_id]` (detail + key_results)
3. –í—ã–∑–≤–∞—Ç—å `context_builder.build_map_context()` –∏–ª–∏ `build_target_context()`
4. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–∞–∑–º–µ—Ä –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ —á–µ—Ä–µ–∑ `estimate_tokens()`:
   - –ï—Å–ª–∏ > 100k —Ç–æ–∫–µ–Ω–æ–≤ ‚Üí –≤–µ—Ä–Ω—É—Ç—å –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ –≤ SSE-–ø–æ—Ç–æ–∫–µ
5. –í—ã–∑–≤–∞—Ç—å `cases_service.run_case(case_id, context, mode)`
6. –°—Ç—Ä–∏–º–∏—Ç—å –æ—Ç–≤–µ—Ç —á–µ—Ä–µ–∑ SSE

**–û—Ç–≤–µ—Ç:** SSE stream (–∫–∞–∫ –≤ v1)

**–ê–¥–∞–ø—Ç–∞—Ü–∏—è –∫–µ–π—Å–æ–≤:**

| –ö–µ–π—Å | –†–µ–∂–∏–º | –ü—Ä–æ–º–ø—Ç –∞–¥–∞–ø—Ç–∏—Ä–æ–≤–∞–Ω |
|------|-------|---------------------|
| 1. –§–æ—Ä–º—É–ª–∏—Ä–æ–≤–∫–∞ —Ü–µ–ª–∏ | target | –ü–µ—Ä–µ–¥–∞—ë—Ç—Å—è `build_target_context` + –ø—Ä–æ–º–ø—Ç –∫–∞–∫ –≤ v1 |
| 2. –ö–ª—é—á–µ–≤—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã | target | –ü–µ—Ä–µ–¥–∞—ë—Ç—Å—è `build_target_context` + –ø—Ä–æ–º–ø—Ç –∫–∞–∫ –≤ v1 |
| 3. –ö–≤–∞—Ä—Ç–∞–ª—å–Ω–∞—è –¥–µ–∫–æ–º–ø–æ–∑–∏—Ü–∏—è | target | –ü–µ—Ä–µ–¥–∞—ë—Ç—Å—è `build_target_context` + –ø—Ä–æ–º–ø—Ç –∫–∞–∫ –≤ v1 |
| 4. –í–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è –ø–æ –∑–∞–º–µ—á–∞–Ω–∏—è–º | target | –ü–µ—Ä–µ–¥–∞—ë—Ç—Å—è `build_target_context` (–ø–æ–ª–µ Notes) + –ø—Ä–æ–º–ø—Ç –∫–∞–∫ –≤ v1 |
| 5. –ö–æ–Ω—Ñ–ª–∏–∫—Ç—ã –∏ —Å–ª–µ–ø—ã–µ –∑–æ–Ω—ã | map | –ü–µ—Ä–µ–¥–∞—ë—Ç—Å—è `build_map_context` + –ø—Ä–æ–º–ø—Ç –∫–∞–∫ –≤ v1 |
| 6. –†–∏—Å–∫–∏ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è | target | –ü–µ—Ä–µ–¥–∞—ë—Ç—Å—è `build_target_context` + –ø—Ä–æ–º–ø—Ç –∫–∞–∫ –≤ v1 |
| 7. –≠–∫—Å–ø—Ä–µ—Å—Å-–æ—Ç—á—ë—Ç | map | –ü–µ—Ä–µ–¥–∞—ë—Ç—Å—è `build_map_context` + –ø—Ä–æ–º–ø—Ç –∫–∞–∫ –≤ v1 |

---

### POST `/api/chat`

**–û–ø–∏—Å–∞–Ω–∏–µ:** –°–≤–æ–±–æ–¥–Ω—ã–π —á–∞—Ç —Å –ò–ò-–ø–æ–º–æ—â–Ω–∏–∫–æ–º (SSE).

**Body:**
```json
{
  "mode": "map" | "target",
  "map_id": 15,
  "target_id": 97,
  "session_id": "sess_...",
  "messages": [
    {"role": "user", "content": "..."},
    {"role": "assistant", "content": "..."}
  ]
}
```

**–õ–æ–≥–∏–∫–∞:**
1. –ó–∞–≥—Ä—É–∑–∏—Ç—å –∫–æ–Ω—Ç–µ–∫—Å—Ç –∏–∑ –∫—ç—à–∞ (–∫–∞–∫ –≤ `/api/cases`)
2. –ü–æ—Å—Ç—Ä–æ–∏—Ç—å —Å–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç + –∫–æ–Ω—Ç–µ–∫—Å—Ç
3. –î–æ–±–∞–≤–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é `messages`
4. –í—ã–∑–≤–∞—Ç—å `llm_service.stream_completion(messages)`
5. –°—Ç—Ä–∏–º–∏—Ç—å –æ—Ç–≤–µ—Ç —á–µ—Ä–µ–∑ SSE

**–û—Ç–≤–µ—Ç:** SSE stream

---

### POST `/api/feedback`

**–û–ø–∏—Å–∞–Ω–∏–µ:** –°–æ—Ö—Ä–∞–Ω—è–µ—Ç –æ—Ü–µ–Ω–∫—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (üëç/üëé).

**Body:**
```json
{
  "case_id": 1,
  "session_id": "sess_...",
  "vote": 1  // 1 = üëç, -1 = üëé
}
```

**–û—Ç–≤–µ—Ç:**
```json
{"success": true}
```

---

### GET `/api/metrics`

**–û–ø–∏—Å–∞–Ω–∏–µ:** –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∞–≥—Ä–µ–≥–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –º–µ—Ç—Ä–∏–∫–∏ –¥–ª—è –±—ç–∫-–æ—Ñ–∏—Å–∞.

**–û—Ç–≤–µ—Ç:** (–ø–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∏–∑ v1)

```json
{
  "total_requests": 156,
  "unique_ips": 12,
  "ip_stats": [{"ip": "192.168.1.5", "count": 42}],
  "case_stats": [
    {
      "case_id": 1,
      "requests": 15,
      "positive": 12,
      "negative": 2,
      "pct_positive": 85.7
    }
  ],
  "timeline": [{"date": "2026-02-15", "count": 18}],
  "total_positive_pct": 78.5,
  "top_maps": [
    {"map_id": 15, "name": "–¶–µ–ª–∏ –Ω–∞ 2026. –†–∞–∑—Ä–∞–±–æ—Ç–∫–∞ Ario", "count": 45}
  ],
  "top_targets": [
    {"target_id": 97, "code": "U-26.4.2", "name": "–£—Å–∏–ª–∏—Ç—å —Ä–æ–ª—å –¶–ö –ø–æ –ò–ò", "count": 28}
  ]
}
```

**–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ –¥–ª—è v2:**

- `top_maps` ‚Äî —Ç–æ–ø-5 –∫–∞—Ä—Ç –ø–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤—É –æ–±—Ä–∞—â–µ–Ω–∏–π (JOIN —Å —Ç–∞–±–ª–∏—Ü–µ–π `requests` –ø–æ `map_id`)
- `top_targets` ‚Äî —Ç–æ–ø-5 —Ü–µ–ª–µ–π –ø–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤—É –æ–±—Ä–∞—â–µ–Ω–∏–π (JOIN –ø–æ `target_id`)

**–°—Ö–µ–º–∞ –ë–î:** –î–æ–±–∞–≤–∏—Ç—å –ø–æ–ª—è `map_id`, `target_id` –≤ —Ç–∞–±–ª–∏—Ü—É `requests`.

---

## UI Layout (index.html)

### –û–±—â–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ Header: Directum Targets AI Assistant | /backoffice    ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ              ‚îÇ                                          ‚îÇ
‚îÇ  –õ–µ–≤–∞—è       ‚îÇ  –û—Å–Ω–æ–≤–Ω–∞—è –æ–±–ª–∞—Å—Ç—å                        ‚îÇ
‚îÇ  –ø–∞–Ω–µ–ª—å      ‚îÇ                                          ‚îÇ
‚îÇ  (280px)     ‚îÇ  [Tabs: 7 –∫–µ–π—Å–æ–≤ | –°–≤–æ–±–æ–¥–Ω—ã–π —á–∞—Ç]       ‚îÇ
‚îÇ              ‚îÇ  [–ö–Ω–æ–ø–∫–∏ –∫–µ–π—Å–æ–≤ 1-7 –∏–ª–∏ 5,7]             ‚îÇ
‚îÇ              ‚îÇ  [–û–±–ª–∞—Å—Ç—å –≤—ã–≤–æ–¥–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞]             ‚îÇ
‚îÇ              ‚îÇ  [–ß–∞—Ç: –∏—Å—Ç–æ—Ä–∏—è + input + "–ù–æ–≤–∞—è –±–µ—Å–µ–¥–∞"] ‚îÇ
‚îÇ              ‚îÇ                                          ‚îÇ
‚îÇ  [–§–∏–ª—å—Ç—Ä]    ‚îÇ                                          ‚îÇ
‚îÇ  [–ö–∞—Ä—Ç—ã]     ‚îÇ                                          ‚îÇ
‚îÇ  [–¶–µ–ª–∏]      ‚îÇ                                          ‚îÇ
‚îÇ              ‚îÇ                                          ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### –õ–µ–≤–∞—è –ø–∞–Ω–µ–ª—å

```html
<aside class="sidebar">
  <!-- –§–∏–ª—å—Ç—Ä –ø–µ—Ä–∏–æ–¥–∞ -->
  <div class="sidebar-section">
    <label>–ü–µ—Ä–∏–æ–¥:</label>
    <select id="period-filter" onchange="filterMapsByPeriod()">
      <option value="">‚Äî –≤—Å–µ –ø–µ—Ä–∏–æ–¥—ã ‚Äî</option>
      <option value="2026">2026</option>
      <option value="1 –∫–≤–∞—Ä—Ç–∞–ª 2026">1 –∫–≤–∞—Ä—Ç–∞–ª 2026</option>
    </select>
  </div>

  <!-- –°–ø–∏—Å–æ–∫ –∫–∞—Ä—Ç -->
  <div class="sidebar-section">
    <h3>–ö–∞—Ä—Ç—ã —Ü–µ–ª–µ–π</h3>
    <div id="maps-list" class="maps-list">
      <!-- –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ –∑–∞–ø–æ–ª–Ω—è–µ—Ç—Å—è —á–µ—Ä–µ–∑ app.js -->
      <div class="map-item" data-map-id="15" onclick="selectMap(15)">
        <div class="map-name">–¶–µ–ª–∏ –Ω–∞ 2026. –†–∞–∑—Ä–∞–±–æ—Ç–∫–∞ Ario</div>
        <div class="map-meta">31.0% ‚Ä¢ Active</div>
      </div>
    </div>
  </div>

  <!-- –°–ø–∏—Å–æ–∫ —Ü–µ–ª–µ–π (–ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è –ø–æ—Å–ª–µ –≤—ã–±–æ—Ä–∞ –∫–∞—Ä—Ç—ã) -->
  <div id="goals-section" class="sidebar-section hidden">
    <h3>–¶–µ–ª–∏ –∫–∞—Ä—Ç—ã</h3>
    <div id="goals-list" class="goals-list">
      <!-- –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ –∑–∞–ø–æ–ª–Ω—è–µ—Ç—Å—è -->
      <div class="goal-item" data-target-id="97" onclick="selectGoal(97)">
        <div class="goal-code">U-26.4.2</div>
        <div class="goal-name">–£—Å–∏–ª–∏—Ç—å —Ä–æ–ª—å –¶–ö –ø–æ –ò–ò...</div>
        <div class="goal-meta">12.5% ‚Ä¢ Green</div>
      </div>
    </div>
  </div>
</aside>
```

**–õ–æ–≥–∏–∫–∞:**

1. –ü—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã: `loadMaps()` ‚Üí GET `/api/maps` ‚Üí –∑–∞–ø–æ–ª–Ω–∏—Ç—å —Å–ø–∏—Å–æ–∫ –∫–∞—Ä—Ç
2. –ü—Ä–∏ —Å–º–µ–Ω–µ —Ñ–∏–ª—å—Ç—Ä–∞ –ø–µ—Ä–∏–æ–¥–∞: –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—å —Å–ø–∏—Å–æ–∫ –∫–∞—Ä—Ç —Å query-–ø–∞—Ä–∞–º–µ—Ç—Ä–æ–º `?period=2026`
3. –ü—Ä–∏ –∫–ª–∏–∫–µ –Ω–∞ –∫–∞—Ä—Ç—É: `selectMap(map_id)` ‚Üí GET `/api/maps/{map_id}/goals` ‚Üí –∑–∞–ø–æ–ª–Ω–∏—Ç—å —Å–ø–∏—Å–æ–∫ —Ü–µ–ª–µ–π, –ø–æ–∫–∞–∑–∞—Ç—å —Å–µ–∫—Ü–∏—é —Ü–µ–ª–µ–π
4. –ü—Ä–∏ –∫–ª–∏–∫–µ –Ω–∞ —Ü–µ–ª—å: `selectGoal(target_id)` ‚Üí GET `/api/targets/{target_id}` ‚Üí —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤ `state.selectedTarget`, –ø–æ–¥—Å–≤–µ—Ç–∏—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—É—é —Ü–µ–ª—å

**–°–æ—Å—Ç–æ—è–Ω–∏–µ UI:**
- –í—ã–±—Ä–∞–Ω–Ω–∞—è –∫–∞—Ä—Ç–∞ ‚Üí –ø–æ–¥—Å–≤–µ—Ç–∫–∞ `.map-item.active`
- –í—ã–±—Ä–∞–Ω–Ω–∞—è —Ü–µ–ª—å ‚Üí –ø–æ–¥—Å–≤–µ—Ç–∫–∞ `.goal-item.active`
- –ï—Å–ª–∏ –∫–∞—Ä—Ç–∞ –≤—ã–±—Ä–∞–Ω–∞, –Ω–æ —Ü–µ–ª—å –Ω–µ—Ç ‚Üí **—Ä–µ–∂–∏–º ¬´–ö–∞—Ä—Ç–∞¬ª** (–¥–æ—Å—Ç—É–ø–Ω—ã –∫–µ–π—Å—ã 5, 7)
- –ï—Å–ª–∏ —Ü–µ–ª—å –≤—ã–±—Ä–∞–Ω–∞ ‚Üí **—Ä–µ–∂–∏–º ¬´–¶–µ–ª—å¬ª** (–¥–æ—Å—Ç—É–ø–Ω—ã –∫–µ–π—Å—ã 1, 2, 3, 4, 6)

---

### –û—Å–Ω–æ–≤–Ω–∞—è –æ–±–ª–∞—Å—Ç—å

```html
<main class="main-area">
  <!-- –í–∫–ª–∞–¥–∫–∏ -->
  <div class="tabs">
    <button class="tab-btn active" onclick="switchTab('cases', this)">7 –∫–µ–π—Å–æ–≤</button>
    <button class="tab-btn" onclick="switchTab('chat', this)">–°–≤–æ–±–æ–¥–Ω—ã–π —á–∞—Ç</button>
  </div>

  <!-- –ö–æ–Ω—Ç–µ–Ω—Ç –≤–∫–ª–∞–¥–∫–∏ "7 –∫–µ–π—Å–æ–≤" -->
  <div id="tab-cases" class="tab-content active">
    <!-- –ê–¥–∞–ø—Ç–∏–≤–Ω—ã–µ –∫–Ω–æ–ø–∫–∏ –∫–µ–π—Å–æ–≤ -->
    <div id="cases-grid" class="cases-grid">
      <!-- –ö–µ–π—Å—ã 1-4, 6 –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç—Å—è —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ target –≤—ã–±—Ä–∞–Ω -->
      <div class="case-card" data-case-id="1" data-mode="target">
        <div class="case-number">–ö–µ–π—Å 1</div>
        <div class="case-title">–°—Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∞—Ç—å –æ–ø–∏—Å–∞–Ω–∏–µ —Ü–µ–ª–∏</div>
        <div class="case-desc">–ü—Ä–æ–≤–µ—Ä–∫–∞ SMART, –∞–º–±–∏—Ü–∏–æ–∑–Ω–æ—Å—Ç—å, –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤</div>
        <button onclick="runCase(1)">–ó–∞–ø—É—Å—Ç–∏—Ç—å</button>
      </div>

      <!-- –ö–µ–π—Å—ã 5, 7 –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç—Å—è –µ—Å–ª–∏ map –≤—ã–±—Ä–∞–Ω–∞ -->
      <div class="case-card" data-case-id="5" data-mode="map">
        <div class="case-number">–ö–µ–π—Å 5</div>
        <div class="case-title">–ù–∞–π—Ç–∏ –∫–æ–Ω—Ñ–ª–∏–∫—Ç—ã –∏ —Å–ª–µ–ø—ã–µ –∑–æ–Ω—ã</div>
        <div class="case-desc">–ê–Ω–∞–ª–∏–∑ —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏ –ø–æ –≤—Å–µ–π –∫–∞—Ä—Ç–µ</div>
        <button onclick="runCase(5)">–ó–∞–ø—É—Å—Ç–∏—Ç—å</button>
      </div>
    </div>

    <!-- –û–±–ª–∞—Å—Ç—å –≤—ã–≤–æ–¥–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ -->
    <div id="result-area" class="result-area hidden">
      <div class="result-header">
        <span id="result-case-label"></span>
        <span id="result-loading" class="spinner hidden"></span>
      </div>
      <div id="result-content" class="result-content"></div>

      <!-- –û—Ü–µ–Ω–∫–∞ -->
      <div id="feedback-bar" class="feedback-bar hidden">
        <span>–û—Ü–µ–Ω–∏—Ç–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç:</span>
        <button id="btn-thumbs-up" onclick="sendFeedback(1)">üëç</button>
        <button id="btn-thumbs-down" onclick="sendFeedback(-1)">üëé</button>
        <span id="feedback-sent" class="hidden">–°–ø–∞—Å–∏–±–æ!</span>
      </div>
    </div>
  </div>

  <!-- –ö–æ–Ω—Ç–µ–Ω—Ç –≤–∫–ª–∞–¥–∫–∏ "–°–≤–æ–±–æ–¥–Ω—ã–π —á–∞—Ç" -->
  <div id="tab-chat" class="tab-content">
    <div class="chat-container">
      <div id="chat-messages" class="chat-messages">
        <div class="chat-message assistant">
          –ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ! –Ø –ø–æ–º–æ–≥—É –≤–∞–º —Ä–∞–±–æ—Ç–∞—Ç—å —Å —Ü–µ–ª—è–º–∏ –∏–∑ Directum Targets.
          –í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ä—Ç—É –∏–ª–∏ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—É—é —Ü–µ–ª—å —Å–ª–µ–≤–∞, –∑–∞—Ç–µ–º –∑–∞–¥–∞–π—Ç–µ –≤–æ–ø—Ä–æ—Å.
        </div>
      </div>
      <div class="chat-input-area">
        <textarea id="chat-input" placeholder="–ó–∞–¥–∞–π—Ç–µ –≤–æ–ø—Ä–æ—Å..."></textarea>
        <button id="btn-chat-send" onclick="sendChatMessage()">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
        <button id="btn-new-conversation" onclick="resetConversation()">–ù–æ–≤–∞—è –±–µ—Å–µ–¥–∞</button>
      </div>
    </div>
  </div>
</main>
```

**–õ–æ–≥–∏–∫–∞ –∞–¥–∞–ø—Ç–∏–≤–Ω—ã—Ö –∫–µ–π—Å–æ–≤:**

```js
function updateCasesVisibility() {
  const hasTarget = state.selectedTarget !== null;
  const hasMap = state.selectedMap !== null;

  document.querySelectorAll('.case-card').forEach(card => {
    const mode = card.dataset.mode; // "map" or "target"
    if (mode === 'target' && !hasTarget) {
      card.classList.add('disabled');
    } else if (mode === 'map' && !hasMap) {
      card.classList.add('disabled');
    } else {
      card.classList.remove('disabled');
    }
  });
}
```

**–ö–Ω–æ–ø–∫–∞ "–ù–æ–≤–∞—è –±–µ—Å–µ–¥–∞":**

```js
function resetConversation() {
  state.chatMessages = [];
  sessionStorage.removeItem('targets_chat');
  document.getElementById('chat-messages').innerHTML = `
    <div class="chat-message assistant">
      –ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ! –Ø –ø–æ–º–æ–≥—É –≤–∞–º —Ä–∞–±–æ—Ç–∞—Ç—å —Å —Ü–µ–ª—è–º–∏ –∏–∑ Directum Targets.
      –í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ä—Ç—É –∏–ª–∏ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—É—é —Ü–µ–ª—å —Å–ª–µ–≤–∞, –∑–∞—Ç–µ–º –∑–∞–¥–∞–π—Ç–µ –≤–æ–ø—Ä–æ—Å.
    </div>
  `;
  // –í—ã–±—Ä–∞–Ω–Ω–∞—è –∫–∞—Ä—Ç–∞/—Ü–µ–ª—å –æ—Å—Ç–∞—é—Ç—Å—è!
}
```

---

## –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ API

### 401 Unauthorized

**–ü—Ä–∏—á–∏–Ω–∞:** Bearer-—Ç–æ–∫–µ–Ω –∏—Å—Ç—ë–∫ –∏–ª–∏ –Ω–µ–≤–∞–ª–∏–¥–µ–Ω.

**–û–±—Ä–∞–±–æ—Ç–∫–∞:**

```python
# –í targets_api.py
except httpx.HTTPStatusError as e:
    if e.response.status_code == 401:
        raise HTTPException(
            status_code=401,
            detail="Bearer-—Ç–æ–∫–µ–Ω –∏—Å—Ç—ë–∫. –û–±–Ω–æ–≤–∏—Ç–µ TARGETS_TOKEN –≤ .env –∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ."
        )
```

**UI:** –ü–æ–∫–∞–∑–∞—Ç—å –∫—Ä–∞—Å–Ω—ã–π –∞–ª–µ—Ä—Ç —Å —Å–æ–æ–±—â–µ–Ω–∏–µ–º –æ–± –æ—à–∏–±–∫–µ.

---

### 403 Forbidden

**–ü—Ä–∏—á–∏–Ω–∞:** –¢–æ–∫–µ–Ω –Ω–µ –∏–º–µ–µ—Ç –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞ –∫ —Ä–µ—Å—É—Ä—Å—É.

**–û–±—Ä–∞–±–æ—Ç–∫–∞:**

```python
if e.response.status_code == 403:
    raise HTTPException(
        status_code=403,
        detail="–î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â—ë–Ω. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø—Ä–∞–≤–∞ —Ç–æ–∫–µ–Ω–∞ –≤ —Å–∏—Å—Ç–µ–º–µ Targets."
    )
```

---

### 500 Server Error

**–ü—Ä–∏—á–∏–Ω–∞:** –í–Ω—É—Ç—Ä–µ–Ω–Ω—è—è –æ—à–∏–±–∫–∞ API Targets.

**–û–±—Ä–∞–±–æ—Ç–∫–∞:**

```python
if e.response.status_code >= 500:
    raise HTTPException(
        status_code=500,
        detail=f"–û—à–∏–±–∫–∞ API Targets: {e.response.text}"
    )
```

---

### Timeout

**–ü—Ä–∏—á–∏–Ω–∞:** API Targets –Ω–µ –æ—Ç–≤–µ—á–∞–µ—Ç.

**–û–±—Ä–∞–±–æ—Ç–∫–∞:**

```python
# –í httpx.AsyncClient
timeout = httpx.Timeout(30.0)  # 30 —Å–µ–∫

except httpx.TimeoutException:
    raise HTTPException(
        status_code=504,
        detail="–¢–∞–π–º–∞—É—Ç API Targets. –ü–æ–≤—Ç–æ—Ä–∏—Ç–µ –∑–∞–ø—Ä–æ—Å –ø–æ–∑–∂–µ."
    )
```

---

### –ü—Ä–µ–≤—ã—à–µ–Ω–∏–µ –ª–∏–º–∏—Ç–∞ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞

**–ü—Ä–∏—á–∏–Ω–∞:** –ö–∞—Ä—Ç–∞ —Ü–µ–ª–µ–π —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–∞—è (>100k —Ç–æ–∫–µ–Ω–æ–≤).

**–û–±—Ä–∞–±–æ—Ç–∫–∞:**

```python
# –í context_builder.py
if estimate_tokens(context) > 100000:
    return {
        "warning": "–ö–∞—Ä—Ç–∞ —Ü–µ–ª–µ–π –æ—á–µ–Ω—å –±–æ–ª—å—à–∞—è (>100k —Ç–æ–∫–µ–Ω–æ–≤). "
                   "–†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –≤—ã–±—Ä–∞—Ç—å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—É—é —Ü–µ–ª—å –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞. "
                   "–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å? (–Ω–µ–∫–æ—Ç–æ—Ä—ã–µ –¥–∞–Ω–Ω—ã–µ –º–æ–≥—É—Ç –±—ã—Ç—å –æ–±—Ä–µ–∑–∞–Ω—ã)"
    }
```

**UI:** –ü–æ–∫–∞–∑–∞—Ç—å –∂—ë–ª—Ç—ã–π –∞–ª–µ—Ä—Ç —Å –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ–º, –¥–∞—Ç—å –∫–Ω–æ–ø–∫—É "–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å" –∏–ª–∏ "–í—ã–±—Ä–∞—Ç—å —Ü–µ–ª—å".

---

## –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### Unit-—Ç–µ—Å—Ç—ã (pytest)

**–ù–æ–≤—ã–µ —Ç–µ—Å—Ç—ã:**

1. **`tests/unit/test_targets_api.py`** ‚Äî —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ HTTP-–∫–ª–∏–µ–Ω—Ç–∞ —Å –º–æ–∫–∞–º–∏ `httpx`:
   ```python
   @pytest.mark.asyncio
   async def test_get_maps_success(httpx_mock):
       httpx_mock.add_response(json={"value": [{"Id": 15, "Name": "Test"}]})
       maps = await get_maps()
       assert len(maps) == 1
       assert maps[0].id == 15

   @pytest.mark.asyncio
   async def test_get_maps_401(httpx_mock):
       httpx_mock.add_response(status_code=401)
       with pytest.raises(HTTPException) as exc_info:
           await get_maps()
       assert exc_info.value.status_code == 401
       assert "—Ç–æ–∫–µ–Ω –∏—Å—Ç—ë–∫" in exc_info.value.detail.lower()
   ```

2. **`tests/unit/test_context_builder.py`** ‚Äî —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è:
   ```python
   def test_normalize_text():
       input_text = "–¢–µ–∫—Å—Ç —Å \\n –ø–µ—Ä–µ–Ω–æ—Å–∞–º–∏ \\r –∏ \\\\ —Å–ª–µ—à–∞–º–∏"
       expected = "–¢–µ–∫—Å—Ç —Å \n –ø–µ—Ä–µ–Ω–æ—Å–∞–º–∏  –∏ \\ —Å–ª–µ—à–∞–º–∏"
       assert normalize_text(input_text) == expected

   def test_build_target_context():
       target = TargetDetail(id=97, name="Test", ...)
       key_results = [KeyResult(description="KR1", ...)]
       context = build_target_context(target, key_results)
       assert "–¶–µ–ª—å: [" in context
       assert "–ö–ª—é—á–µ–≤—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã:" in context
       assert "KR1" in context

   def test_estimate_tokens():
       text = "–ö–æ—Ä–æ—Ç–∫–∏–π —Ç–µ–∫—Å—Ç"
       tokens = estimate_tokens(text)
       assert tokens > 0
       assert tokens < 10
   ```

3. **`tests/unit/test_cases_service.py`** ‚Äî –∞–¥–∞–ø—Ç–∞—Ü–∏—è –ø–æ–¥ –Ω–æ–≤—ã–π —Ñ–æ—Ä–º–∞—Ç –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞:
   ```python
   @pytest.mark.asyncio
   async def test_case1_target_mode(mocker):
       mock_llm = mocker.patch('src.services.llm_service.stream_completion')
       mock_llm.return_value = async_generator(["chunk1", "chunk2"])

       context = "–¶–µ–ª—å: [U-26.4.2] Test..."
       generator = await run_case(1, mode="target", context=context)
       chunks = [chunk async for chunk in generator]

       assert len(chunks) == 2
       mock_llm.assert_called_once()
       messages = mock_llm.call_args[0][0]
       assert any("SMART" in str(m) for m in messages)
   ```

**–°—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —Ç–µ—Å—Ç—ã (–ø–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è):**

- `test_llm_service.py` ‚Äî as-is (stream_completion –Ω–µ –º–µ–Ω—è–µ—Ç—Å—è)
- `test_metrics.py` ‚Äî as-is + –¥–æ–±–∞–≤–∏—Ç—å —Ç–µ—Å—Ç—ã –¥–ª—è `top_maps`, `top_targets`

**Coverage:** ‚â•70% –ø–æ –≤—Å–µ–º –º–æ–¥—É–ª—è–º.

---

### E2E-—Ç–µ—Å—Ç—ã (Playwright)

**–§–∞–π–ª:** `tests/e2e/test_ui_flow.py`

**–°—Ü–µ–Ω–∞—Ä–∏–∏:**

1. **–ó–∞–≥—Ä—É–∑–∫–∞ –≥–ª–∞–≤–Ω–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã:**
   ```python
   def test_index_page_loads(page):
       page.goto("http://localhost:8000/")
       assert page.title() == "Directum Targets AI Assistant"
       assert page.locator(".sidebar").is_visible()
   ```

2. **–§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –∫–∞—Ä—Ç –ø–æ –ø–µ—Ä–∏–æ–¥—É:**
   ```python
   def test_filter_maps_by_period(page):
       page.goto("http://localhost:8000/")
       page.select_option("#period-filter", "2026")
       page.wait_for_timeout(1000)  # –ñ–¥—ë–º –∑–∞–≥—Ä—É–∑–∫–∏
       maps = page.locator(".map-item").all()
       assert len(maps) > 0
       # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –≤—Å–µ –∫–∞—Ä—Ç—ã —Å–æ–¥–µ—Ä–∂–∞—Ç "2026" –≤ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö
   ```

3. **–í—ã–±–æ—Ä –∫–∞—Ä—Ç—ã ‚Üí –∑–∞–≥—Ä—É–∑–∫–∞ —Ü–µ–ª–µ–π:**
   ```python
   def test_select_map_loads_goals(page):
       page.goto("http://localhost:8000/")
       page.click(".map-item[data-map-id='15']")
       page.wait_for_selector(".goal-item")
       goals = page.locator(".goal-item").all()
       assert len(goals) > 0
   ```

4. **–í—ã–±–æ—Ä —Ü–µ–ª–∏ ‚Üí –∞–¥–∞–ø—Ç–∏–≤–Ω—ã–µ –∫–µ–π—Å—ã:**
   ```python
   def test_select_goal_shows_target_cases(page):
       page.goto("http://localhost:8000/")
       page.click(".map-item[data-map-id='15']")
       page.click(".goal-item[data-target-id='97']")
       page.wait_for_timeout(500)

       # –ö–µ–π—Å—ã 1-4, 6 –¥–æ—Å—Ç—É–ø–Ω—ã
       assert not page.locator(".case-card[data-case-id='1']").get_attribute("class").includes("disabled")
       # –ö–µ–π—Å 5 –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω (–¥–ª—è –∫–∞—Ä—Ç—ã)
       assert page.locator(".case-card[data-case-id='5']").get_attribute("class").includes("disabled")
   ```

5. **–ó–∞–ø—É—Å–∫ –∫–µ–π—Å–∞ ‚Üí SSE —Å—Ç—Ä–∏–º–∏–Ω–≥:**
   ```python
   def test_run_case_streams_result(page):
       page.goto("http://localhost:8000/")
       page.click(".map-item[data-map-id='15']")
       page.click(".goal-item[data-target-id='97']")
       page.click(".case-card[data-case-id='1'] button")

       page.wait_for_selector("#result-area:not(.hidden)")
       page.wait_for_selector("#result-content", state="visible")
       page.wait_for_timeout(2000)  # –î–∞—ë–º –≤—Ä–µ–º—è –Ω–∞ —Å—Ç—Ä–∏–º–∏–Ω–≥

       content = page.locator("#result-content").text_content()
       assert len(content) > 100  # –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –µ—Å—Ç—å –∫–æ–Ω—Ç–µ–Ω—Ç
   ```

6. **–û—Ü–µ–Ω–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞:**
   ```python
   def test_feedback_thumbs_up(page):
       # ... –∑–∞–ø—É—Å–∫ –∫–µ–π—Å–∞ ...
       page.wait_for_selector("#feedback-bar:not(.hidden)")
       page.click("#btn-thumbs-up")
       page.wait_for_selector("#feedback-sent:not(.hidden)")
       assert page.locator("#btn-thumbs-up").get_attribute("class").includes("active-pos")
   ```

7. **–°–≤–æ–±–æ–¥–Ω—ã–π —á–∞—Ç:**
   ```python
   def test_chat_sends_message(page):
       page.goto("http://localhost:8000/")
       page.click(".map-item[data-map-id='15']")
       page.click(".tab-btn:has-text('–°–≤–æ–±–æ–¥–Ω—ã–π —á–∞—Ç')")
       page.fill("#chat-input", "–ö–∞–∫–∏–µ —Ü–µ–ª–∏ –≤ –∫–∞—Ä—Ç–µ?")
       page.click("#btn-chat-send")

       page.wait_for_selector(".chat-message.user")
       page.wait_for_selector(".chat-message.assistant", state="visible")
       page.wait_for_timeout(2000)

       messages = page.locator(".chat-message.assistant").all()
       assert len(messages) >= 2  # –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ + –æ—Ç–≤–µ—Ç
   ```

8. **–ö–Ω–æ–ø–∫–∞ "–ù–æ–≤–∞—è –±–µ—Å–µ–¥–∞":**
   ```python
   def test_reset_conversation(page):
       # ... –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ ...
       page.click("#btn-new-conversation")
       messages = page.locator(".chat-message").all()
       assert len(messages) == 1  # –¢–æ–ª—å–∫–æ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ
   ```

**–ó–∞–ø—É—Å–∫:**

```bash
# –ó–∞–ø—É—Å—Ç–∏—Ç—å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
docker-compose up -d

# –î–æ–∂–¥–∞—Ç—å—Å—è –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏
sleep 5

# –ó–∞–ø—É—Å—Ç–∏—Ç—å E2E-—Ç–µ—Å—Ç—ã (—Å–Ω–∞—Ä—É–∂–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞!)
pytest tests/e2e/ --headed
```

**–í–∞–∂–Ω–æ:** Playwright **–ù–ï** –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –≤–Ω—É—Ç—Ä–∏ Docker-–∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞. E2E-—Ç–µ—Å—Ç—ã –≤—ã–ø–æ–ª–Ω—è—é—Ç—Å—è –Ω–∞ —Ö–æ—Å—Ç-–º–∞—à–∏–Ω–µ –ø—Ä–æ—Ç–∏–≤ `http://localhost:8000`.

---

## Docker

### Multi-stage Dockerfile

```dockerfile
# ===== STAGE 1: Production –æ–±—Ä–∞–∑ =====
FROM python:3.10-slim AS production

WORKDIR /app

# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt

# –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –∏—Å—Ö–æ–¥–Ω–æ–≥–æ –∫–æ–¥–∞
COPY src/ src/
COPY .env.example .env.example

# –°–æ–∑–¥–∞–Ω–∏–µ –ø–∞–ø–∫–∏ –¥–ª—è –¥–∞–Ω–Ω—ã—Ö
RUN mkdir -p /app/data

EXPOSE 8000

CMD ["uvicorn", "src.main:app", "--host", "0.0.0.0", "--port", "8000"]

# ===== STAGE 2: Test –æ–±—Ä–∞–∑ (–¥–æ–±–∞–≤–ª—è–µ—Ç Playwright) =====
FROM production AS test

# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å–∏—Å—Ç–µ–º–Ω—ã—Ö –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π –¥–ª—è Playwright
RUN apt-get update && apt-get install -y --no-install-recommends \
    libnss3 libnspr4 libatk1.0-0 libatk-bridge2.0-0 \
    libcups2 libdrm2 libdbus-1-3 libxcb1 libxkbcommon0 \
    libx11-6 libxcomposite1 libxdamage1 libxext6 libxfixes3 \
    libxrandr2 libgbm1 libasound2 libpango-1.0-0 libcairo2 \
    fonts-liberation \
    && rm -rf /var/lib/apt/lists/*

# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Playwright
RUN pip install playwright pytest-playwright
RUN playwright install chromium

# –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç–µ—Å—Ç–æ–≤
COPY tests/ tests/
COPY pytest.ini .
COPY .coveragerc .
```

**–°–±–æ—Ä–∫–∞:**

```bash
# Production –æ–±—Ä–∞–∑ (–±–µ–∑ Playwright)
docker build --target production -t targets-ai:prod .

# Test –æ–±—Ä–∞–∑ (—Å Playwright)
docker build --target test -t targets-ai:test .
```

---

### docker-compose.yml

```yaml
version: "3.9"

services:
  app:
    build:
      context: .
      target: production
    ports:
      - "8000:8000"
    volumes:
      - ./data:/app/data
    env_file:
      - .env
    environment:
      - PYTHONUNBUFFERED=1
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/api/health"]
      interval: 30s
      timeout: 5s
      retries: 3

  # –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π —Å–µ—Ä–≤–∏—Å –¥–ª—è –∑–∞–ø—É—Å–∫–∞ unit-—Ç–µ—Å—Ç–æ–≤ –≤–Ω—É—Ç—Ä–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
  test:
    build:
      context: .
      target: test
    volumes:
      - ./data:/app/data
      - ./tests:/app/tests
    env_file:
      - .env
    command: ["pytest", "tests/unit/", "-v", "--cov=src", "--cov-report=term"]
```

**–ó–∞–ø—É—Å–∫:**

```bash
# Production
docker-compose up -d app

# Unit-—Ç–µ—Å—Ç—ã –≤–Ω—É—Ç—Ä–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
docker-compose run --rm test

# E2E-—Ç–µ—Å—Ç—ã —Å–Ω–∞—Ä—É–∂–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ (–ø–æ—Å–ª–µ docker-compose up)
pytest tests/e2e/ --headed
```

---

## –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è

### `.env` (–ù–ï –¢–†–û–ì–ê–¢–¨!)

```dotenv
# OpenAI API
OPENAI_API_KEY=sk-...
OPENAI_MODEL=gpt-4o
OPENAI_BASE_URL=https://api.openai.com/v1

# Directum Targets API
TARGETS_BASE_URL=https://aura.npo-comp.ru
TARGETS_TOKEN=your-bearer-token-here
```

**–ü—Ä–∞–≤–∏–ª–∞:**

- `.env` **–ù–ò–ö–û–ì–î–ê** –Ω–µ —Å–æ–∑–¥–∞—ë—Ç—Å—è, –Ω–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ—Ç—Å—è, –Ω–µ –ø–µ—Ä–µ–∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç—Å—è –∞–≥–µ–Ω—Ç–∞–º–∏!
- –ü—Ä–∏ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏ PM –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç —Å–∏—Å—Ç–µ–º—É –∏ –¥–∞—ë—Ç –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—é –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –∑–∞–ø–æ–ª–Ω–∏—Ç—å `.env` —Ä–µ–∞–ª—å–Ω—ã–º–∏ –∑–Ω–∞—á–µ–Ω–∏—è–º–∏
- `.env.example` ‚Äî —à–∞–±–ª–æ–Ω –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

### `.env.example`

```dotenv
# OpenAI API (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)
OPENAI_API_KEY=sk-your-key-here
OPENAI_MODEL=gpt-4o
OPENAI_BASE_URL=https://api.openai.com/v1

# Directum Targets API (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –¥–ª—è v2)
TARGETS_BASE_URL=https://your-targets-instance.ru
TARGETS_TOKEN=your-bearer-token-here
```

---

## Backoffice

### –ò–∑–º–µ–Ω–µ–Ω–∏—è –≤ –ë–î

**–¢–∞–±–ª–∏—Ü–∞ `requests`:** –î–æ–±–∞–≤–∏—Ç—å –ø–æ–ª—è `map_id`, `target_id`:

```sql
CREATE TABLE IF NOT EXISTS requests (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    ip TEXT NOT NULL,
    endpoint TEXT NOT NULL,
    case_id INTEGER,
    map_id INTEGER,         -- NEW
    target_id INTEGER,      -- NEW
    timestamp DATETIME DEFAULT CURRENT_TIMESTAMP
);
```

**–ú–∏–≥—Ä–∞—Ü–∏—è:** –í `init_db()` –¥–æ–±–∞–≤–∏—Ç—å `ALTER TABLE` –¥–ª—è —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –±–∞–∑:

```python
cursor.execute("PRAGMA table_info(requests)")
columns = [col[1] for col in cursor.fetchall()]
if "map_id" not in columns:
    cursor.execute("ALTER TABLE requests ADD COLUMN map_id INTEGER")
if "target_id" not in columns:
    cursor.execute("ALTER TABLE requests ADD COLUMN target_id INTEGER")
```

### –ù–æ–≤—ã–µ –º–µ—Ç—Ä–∏–∫–∏

**–¢–æ–ø-5 –∫–∞—Ä—Ç:**

```python
cursor.execute("""
    SELECT map_id, COUNT(*) as cnt
    FROM requests
    WHERE map_id IS NOT NULL
    GROUP BY map_id
    ORDER BY cnt DESC
    LIMIT 5
""")
top_maps_raw = cursor.fetchall()

# –û–±–æ–≥–∞—â–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã–º–∏ (–Ω–∞–∑–≤–∞–Ω–∏–µ –∫–∞—Ä—Ç—ã):
# –í —Ä–µ–∞–ª—å–Ω–æ—Å—Ç–∏ –Ω—É–∂–Ω–æ —Å–æ—Ö—Ä–∞–Ω—è—Ç—å –Ω–∞–∑–≤–∞–Ω–∏—è –≤ –∫—ç—à–µ –∏–ª–∏ –æ—Ç–¥–µ–ª—å–Ω–æ–π —Ç–∞–±–ª–∏—Ü–µ
# –î–ª—è –ø—Ä–æ—Ç–æ—Ç–∏–ø–∞ –º–æ–∂–Ω–æ –≤–µ—Ä–Ω—É—Ç—å —Ç–æ–ª—å–∫–æ map_id + count
top_maps = [{"map_id": r[0], "count": r[1]} for r in top_maps_raw]
```

**–¢–æ–ø-5 —Ü–µ–ª–µ–π:**

```python
cursor.execute("""
    SELECT target_id, COUNT(*) as cnt
    FROM requests
    WHERE target_id IS NOT NULL
    GROUP BY target_id
    ORDER BY cnt DESC
    LIMIT 5
""")
top_targets_raw = cursor.fetchall()
top_targets = [{"target_id": r[0], "count": r[1]} for r in top_targets_raw]
```

**–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ:** –î–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –Ω–∞–∑–≤–∞–Ω–∏–π –∫–∞—Ä—Ç/—Ü–µ–ª–µ–π –≤ –±—ç–∫-–æ—Ñ–∏—Å–µ –º–æ–∂–Ω–æ:
1. –•—Ä–∞–Ω–∏—Ç—å –∫—ç—à –≤ –æ—Ç–¥–µ–ª—å–Ω–æ–π —Ç–∞–±–ª–∏—Ü–µ `maps_cache`, `targets_cache`
2. –ò–ª–∏ –¥–µ–ª–∞—Ç—å –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã –∫ Targets API –ø—Ä–∏ —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–µ –±—ç–∫-–æ—Ñ–∏—Å–∞
3. –ò–ª–∏ –ø—Ä–æ—Å—Ç–æ –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å ID (–¥–ª—è –ø—Ä–æ—Ç–æ—Ç–∏–ø–∞ –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ)

---

## –ü–ª–∞–Ω —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏ (–¥–ª—è Developer-–∞–≥–µ–Ω—Ç–∞)

### –≠—Ç–∞–ø 1: API-–∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è

1. –°–æ–∑–¥–∞—Ç—å `src/models/targets.py` ‚Äî Pydantic –º–æ–¥–µ–ª–∏:
   - `TargetsMap`, `MapGraph`, `GoalNode`, `TargetDetail`, `KeyResult`
2. –°–æ–∑–¥–∞—Ç—å `src/services/targets_api.py`:
   - `get_maps()`, `get_map_graph()`, `get_target()`, `get_key_results()`
   - –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ (401, 403, 500, timeout)
3. –î–æ–±–∞–≤–∏—Ç—å –∫–æ–Ω—Ñ–∏–≥:
   - `config.py` ‚Üí `get_targets_base_url()`, `get_targets_token()`
4. Unit-—Ç–µ—Å—Ç—ã —Å –º–æ–∫–∞–º–∏ `httpx`

### –≠—Ç–∞–ø 2: –ö–æ–Ω—Ç–µ–∫—Å—Ç –¥–ª—è LLM

1. –°–æ–∑–¥–∞—Ç—å `src/services/context_builder.py`:
   - `build_map_context()`, `build_target_context()`
   - `normalize_text()`, `estimate_tokens()`
2. Unit-—Ç–µ—Å—Ç—ã —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è

### –≠—Ç–∞–ø 3: Backend API

1. –ú–æ–¥–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞—Ç—å `src/main.py`:
   - –î–æ–±–∞–≤–∏—Ç—å `app.state.cache = {}`
   - –†–æ—É—Ç—ã: `/api/maps`, `/api/maps/{id}/goals`, `/api/targets/{id}`
   - –ú–æ–¥–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞—Ç—å `/api/cases/{id}`, `/api/chat` ‚Üí —Ä–∞–±–æ—Ç–∞ —Å –∫—ç—à–µ–º + –Ω–æ–≤—ã–π —Ñ–æ—Ä–º–∞—Ç –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
2. –ú–æ–¥–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞—Ç—å `src/services/cases_service.py`:
   - –ê–¥–∞–ø—Ç–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ–º–ø—Ç—ã –ø–æ–¥ `build_map_context` / `build_target_context`
3. –ú–æ–¥–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞—Ç—å `src/services/chat_service.py`:
   - –ê–Ω–∞–ª–æ–≥–∏—á–Ω–æ
4. –ú–æ–¥–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞—Ç—å `src/services/metrics_storage.py`:
   - –ú–∏–≥—Ä–∞—Ü–∏—è –ë–î (–¥–æ–±–∞–≤–∏—Ç—å `map_id`, `target_id`)
   - –ù–æ–≤—ã–µ –º–µ—Ç—Ä–∏–∫–∏ `top_maps`, `top_targets`

### –≠—Ç–∞–ø 4: Frontend

1. –ú–æ–¥–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞—Ç—å `src/static/index.html`:
   - –õ–µ–≤–∞—è –ø–∞–Ω–µ–ª—å (sidebar)
   - –ê–¥–∞–ø—Ç–∏–≤–Ω—ã–µ –∫–µ–π—Å—ã (data-mode="map/target")
   - –ö–Ω–æ–ø–∫–∞ "–ù–æ–≤–∞—è –±–µ—Å–µ–¥–∞"
2. –ú–æ–¥–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞—Ç—å `src/static/app.js`:
   - –§—É–Ω–∫—Ü–∏–∏: `loadMaps()`, `filterMapsByPeriod()`, `selectMap()`, `selectGoal()`
   - –§—É–Ω–∫—Ü–∏–∏: `updateCasesVisibility()`, `resetConversation()`
   - Session ID –≤ `sessionStorage`
3. –ú–æ–¥–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞—Ç—å `src/static/style.css`:
   - –î–≤—É—Ö–∫–æ–ª–æ–Ω–æ—á–Ω—ã–π layout (`.sidebar` 280px + `.main-area` flex)
   - –°—Ç–∏–ª–∏ –¥–ª—è `.map-item`, `.goal-item`, `.case-card.disabled`
4. **–ö—Ä–∏—Ç–∏—á–Ω–æ:** –°–∫–∞—á–∞—Ç—å Chart.js –ª–æ–∫–∞–ª—å–Ω–æ –≤ `src/static/` –∏ –æ–±–Ω–æ–≤–∏—Ç—å `backoffice.html`

### –≠—Ç–∞–ø 5: Docker

1. –ú–æ–¥–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞—Ç—å `Dockerfile`:
   - Multi-stage: `production` (–±–µ–∑ Playwright), `test` (—Å Playwright)
2. –ú–æ–¥–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞—Ç—å `docker-compose.yml`:
   - `env_file: - .env`
   - Healthcheck
   - –°–µ—Ä–≤–∏—Å `test` –¥–ª—è unit-—Ç–µ—Å—Ç–æ–≤

### –≠—Ç–∞–ø 6: –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

1. Unit-—Ç–µ—Å—Ç—ã:
   - `test_targets_api.py`, `test_context_builder.py`
   - –ê–¥–∞–ø—Ç–∏—Ä–æ–≤–∞—Ç—å `test_cases_service.py`, `test_chat_service.py`
   - –î–æ–±–∞–≤–∏—Ç—å —Ç–µ—Å—Ç—ã –¥–ª—è –Ω–æ–≤—ã—Ö –º–µ—Ç—Ä–∏–∫
2. E2E-—Ç–µ—Å—Ç—ã:
   - `test_ui_flow.py` ‚Üí 8 —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤ (—Å–º. —Å–µ–∫—Ü–∏—é "–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ")
3. –ü—Ä–æ–≤–µ—Ä–∫–∞ coverage ‚â•70%

### –≠—Ç–∞–ø 7: –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

1. –û–±–Ω–æ–≤–∏—Ç—å `README.md`:
   - –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è `.env` (–¥–æ–±–∞–≤–∏—Ç—å `TARGETS_BASE_URL`, `TARGETS_TOKEN`)
   - –°–∫—Ä–∏–Ω—à–æ—Ç—ã UI (–ª–µ–≤–∞—è –ø–∞–Ω–µ–ª—å, –∞–¥–∞–ø—Ç–∏–≤–Ω—ã–µ –∫–µ–π—Å—ã)
2. –°–æ–∑–¥–∞—Ç—å `TECHNICAL_DOCUMENTATION.md`:
   - API endpoints
   - –§–æ—Ä–º–∞—Ç –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
   - –°—Ö–µ–º–∞ –ë–î
   - –ü—Ä–∏–º–µ—Ä—ã –∑–∞–ø—Ä–æ—Å–æ–≤

---

## –†–∏—Å–∫–∏ –∏ –º–∏—Ç–∏–≥–∞—Ü–∏—è

| –†–∏—Å–∫ | –í–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å | –í–ª–∏—è–Ω–∏–µ | –ú–∏—Ç–∏–≥–∞—Ü–∏—è |
|------|-------------|---------|-----------|
| API Targets –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω –ø—Ä–∏ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ | –í—ã—Å–æ–∫–∞—è | –ö—Ä–∏—Ç–∏—á–µ—Å–∫–æ–µ | **–ú–æ–∫–∏:** –°–æ–∑–¥–∞—Ç—å `tests/fixtures/targets_api_mocks.json` —Å –ø—Ä–∏–º–µ—Ä–∞–º–∏ –æ—Ç–≤–µ—Ç–æ–≤. –í—Å–µ unit-—Ç–µ—Å—Ç—ã –∏—Å–ø–æ–ª—å–∑—É—é—Ç –º–æ–∫–∏. E2E-—Ç–µ—Å—Ç—ã —Ç—Ä–µ–±—É—é—Ç —Ä–µ–∞–ª—å–Ω—ã–π API ‚Äî –∑–∞–ø—É—Å–∫–∞—é—Ç—Å—è —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏. |
| –ö–∞—Ä—Ç–∞ >300 —Ü–µ–ª–µ–π –Ω–µ –≤–ª–µ–∑–∞–µ—Ç –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç | –°—Ä–µ–¥–Ω—è—è | –í—ã—Å–æ–∫–æ–µ | **–õ–∏–º–∏—Ç:** `estimate_tokens()` –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–∞–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è. –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è –ø–µ—Ä–µ–∫–ª—é—á–∏—Ç—å—Å—è –≤ —Ä–µ–∂–∏–º "–¶–µ–ª—å". –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ: –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ–±—Ä–µ–∑–∫–∞ –≤—Ç–æ—Ä–æ—Å—Ç–µ–ø–µ–Ω–Ω—ã—Ö –ø–æ–ª–µ–π (`Description` –¥–ª—è –Ω–µ–ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω—ã—Ö —Ü–µ–ª–µ–π). |
| Bearer-—Ç–æ–∫–µ–Ω –∏—Å—Ç–µ–∫–∞–µ—Ç –≤ –ø—Ä–æ—Ü–µ—Å—Å–µ —Ä–∞–±–æ—Ç—ã | –°—Ä–µ–¥–Ω—è—è | –°—Ä–µ–¥–Ω–µ–µ | **–û–±—Ä–∞–±–æ—Ç–∫–∞ 401:** –ß—ë—Ç–∫–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ —Å –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–µ–π –æ–±–Ω–æ–≤–∏—Ç—å `.env`. –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ: –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π retry —Å –æ–±–Ω–æ–≤–ª—ë–Ω–Ω—ã–º —Ç–æ–∫–µ–Ω–æ–º (–µ—Å–ª–∏ —Ç–æ–∫–µ–Ω –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è —á–µ—Ä–µ–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é –æ–∫—Ä—É–∂–µ–Ω–∏—è –±–µ–∑ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞). |
| –ü–æ–ª—è Notes/Description —Å–æ–¥–µ—Ä–∂–∞—Ç —Å–ø–µ—Ü—Å–∏–º–≤–æ–ª—ã –∏ –ª–æ–º–∞—é—Ç –ø—Ä–æ–º–ø—Ç | –°—Ä–µ–¥–Ω—è—è | –°—Ä–µ–¥–Ω–µ–µ | **–ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è:** `normalize_text()` —É–¥–∞–ª—è–µ—Ç `\n`, `\\`, `\r` –ø–µ—Ä–µ–¥ –ø–µ—Ä–µ–¥–∞—á–µ–π –≤ LLM. Unit-—Ç–µ—Å—Ç—ã –ø–æ–∫—Ä—ã–≤–∞—é—Ç edge cases. |
| –í—Ä–µ–º—è –æ—Ç–≤–µ—Ç–∞ –º–æ–¥–µ–ª–∏ >30 —Å–µ–∫ | –°—Ä–µ–¥–Ω—è—è | –°—Ä–µ–¥–Ω–µ–µ | **SSE —Å—Ç—Ä–∏–º–∏–Ω–≥:** –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–∏–¥–∏—Ç –ø—Ä–æ–≥—Ä–µ—Å—Å. –¢–∞–π–º–∞—É—Ç –Ω–∞ –∫–ª–∏–µ–Ω—Ç–µ ‚Äî 60 —Å–µ–∫ (AbortController). |
| Playwright –≤ production-–æ–±—Ä–∞–∑–µ —É–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç —Ä–∞–∑–º–µ—Ä | –í—ã—Å–æ–∫–∞—è | –ù–∏–∑–∫–æ–µ | **Multi-stage Dockerfile:** Production-–æ–±—Ä–∞–∑ (`target: production`) –ù–ï —Å–æ–¥–µ—Ä–∂–∏—Ç Playwright. Test-–æ–±—Ä–∞–∑ ‚Äî –æ—Ç–¥–µ–ª—å–Ω—ã–π stage. |
| CDN –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω –≤ Docker (Chart.js) | –í—ã—Å–æ–∫–∞—è | –°—Ä–µ–¥–Ω–µ–µ | **–õ–æ–∫–∞–ª—å–Ω—ã–µ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏:** –í—Å–µ JS-–±–∏–±–ª–∏–æ—Ç–µ–∫–∏ (Chart.js, marked.js –µ—Å–ª–∏ –Ω—É–∂–µ–Ω) —Å–∫–∞—á–∏–≤–∞—é—Ç—Å—è –∏ –∫–ª–∞–¥—É—Ç—Å—è –≤ `src/static/`. |
| –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –Ω–µ –¥–∞—é—Ç –æ–±—Ä–∞—Ç–Ω—É—é —Å–≤—è–∑—å | –°—Ä–µ–¥–Ω—è—è | –°—Ä–µ–¥–Ω–µ–µ | **UX:** Feedback-–±–∞—Ä –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ—Å–ª–µ –∫–∞–∂–¥–æ–≥–æ –∫–µ–π—Å–∞. –ú–æ—Ç–∏–≤–∏—Ä—É—é—â–∞—è –ø–æ–¥—Å–∫–∞–∑–∫–∞: "–ü–æ–º–æ–≥–∏—Ç–µ —É–ª—É—á—à–∏—Ç—å –ò–ò-–ø–æ–º–æ—â–Ω–∏–∫–∞ ‚Äî –æ—Ü–µ–Ω–∏—Ç–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç". |

---

## –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–∞–≤–∏–ª–∞ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

### 1. SSE —Å—Ç—Ä–∏–º–∏–Ω–≥

**–ë—ç–∫–µ–Ω–¥:** –ß–∞–Ω–∫ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è —Ü–µ–ª–∏–∫–æ–º, **–ë–ï–ó** `split("\n")`:

```python
yield f"data: {json.dumps(chunk)}\n\n"
```

**–§—Ä–æ–Ω—Ç–µ–Ω–¥:** –ß–∏—Ç–∞—Ç–µ–ª—å –ø–æ—Ç–æ–∫–∞ —Å–æ–±–∏—Ä–∞–µ—Ç —Å—Ç—Ä–æ–∫–∏ —á–µ—Ä–µ–∑ `buffer.split('\n')`, –ø–∞—Ä—Å–∏—Ç `data: ...` —Å–æ–±—ã—Ç–∏—è.

---

### 2. Markdown-—Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥

**–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å:** –ü–æ—Å—Ç—Ä–æ—á–Ω—ã–π `renderMarkdown` –∏–∑ `app.js` (–ø–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∏–∑ v1).

**–ù–ï –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å:** `marked.js` —á–µ—Ä–µ–∑ CDN –∏–ª–∏ –∏–Ω–∫—Ä–µ–º–µ–Ω—Ç–∞–ª—å–Ω—ã–π –ø–∞—Ä—Å–∏–Ω–≥.

---

### 3. AbortController –¥–ª—è –æ—Ç–º–µ–Ω—ã –∑–∞–ø—Ä–æ—Å–æ–≤

**–û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ:** –ü—Ä–∏ –∑–∞–ø—É—Å–∫–µ –Ω–æ–≤–æ–≥–æ –∫–µ–π—Å–∞ –æ—Ç–º–µ–Ω—è—Ç—å –ø—Ä–µ–¥—ã–¥—É—â–∏–π —á–µ—Ä–µ–∑ `state.caseAbortController.abort()`.

**–ß–∏—Ç–∞—Ç–µ–ª—å –ø–æ—Ç–æ–∫–∞:**

```js
signal.addEventListener('abort', () => reader.cancel(), { once: true });
```

---

### 4. –í—Å–µ JS-–±–∏–±–ª–∏–æ—Ç–µ–∫–∏ –ª–æ–∫–∞–ª—å–Ω–æ

**–û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ:** Chart.js, –ª—é–±—ã–µ –¥—Ä—É–≥–∏–µ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ ‚Äî —Å–∫–∞—á–∞—Ç—å –≤ `src/static/` –∏ –ø–æ–¥–∫–ª—é—á–∞—Ç—å —á–µ—Ä–µ–∑ `/static/`.

**–ó–∞–ø—Ä–µ—â–µ–Ω–æ:** CDN (`cdn.jsdelivr.net`, `unpkg.com` –∏ —Ç.–¥.).

---

### 5. –ú–Ω–æ–≥–æ—ç—Ç–∞–ø–Ω—ã–π Dockerfile

**Production stage:** –ë–ï–ó Playwright, Chromium, —Å–∏—Å—Ç–µ–º–Ω—ã—Ö –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π –±—Ä–∞—É–∑–µ—Ä–∞.

**Test stage:** –ù–∞—Å–ª–µ–¥—É–µ—Ç—Å—è –æ—Ç production, –¥–æ–±–∞–≤–ª—è–µ—Ç Playwright.

**E2E-—Ç–µ—Å—Ç—ã:** –ó–∞–ø—É—Å–∫–∞—é—Ç—Å—è **—Å–Ω–∞—Ä—É–∂–∏** –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ –ø—Ä–æ—Ç–∏–≤ `localhost:8000`.

---

### 6. .env –Ω–µ —Ç—Ä–æ–≥–∞—Ç—å

**–ó–∞–ø—Ä–µ—â–µ–Ω–æ:**
- –°–æ–∑–¥–∞–≤–∞—Ç—å `.env` —á–µ—Ä–µ–∑ –∞–≥–µ–Ω—Ç–æ–≤
- –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å `.env`
- –ü–µ—Ä–µ–∑–∞–ø–∏—Å—ã–≤–∞—Ç—å `.env`

**–†–∞–∑—Ä–µ—à–µ–Ω–æ:**
- –°–æ–∑–¥–∞—Ç—å/–æ–±–Ω–æ–≤–∏—Ç—å `.env.example` —Å —à–∞–±–ª–æ–Ω–æ–º

**PM-–∞–≥–µ–Ω—Ç:** –í –∫–æ–Ω—Ü–µ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏ –¥–∞—ë—Ç –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—é –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –∑–∞–ø–æ–ª–Ω–∏—Ç—å `.env` —Ä–µ–∞–ª—å–Ω—ã–º–∏ –∑–Ω–∞—á–µ–Ω–∏—è–º–∏.

---

### 7. –ü–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –∫–æ–¥–∞ –∏–∑ v1

**–ü–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å as-is:**
- `llm_service.py` ‚Üí `stream_completion()`
- `metrics_storage.py` ‚Üí `init_db()`, `log_request()`, `save_feedback()`, `get_metrics()`
- `app.js` ‚Üí `renderMarkdown()`, `readSSEStreamToElement()`, `AbortController` –ø–∞—Ç—Ç–µ—Ä–Ω
- `style.css` ‚Üí –±–∞–∑–æ–≤—ã–µ —Å—Ç–∏–ª–∏ (—Ä–∞—Å—à–∏—Ä–∏—Ç—å –¥–ª—è –ª–µ–≤–æ–π –ø–∞–Ω–µ–ª–∏)
- `backoffice.html`, `backoffice.js` ‚Üí –¥–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—ã–µ –º–µ—Ç—Ä–∏–∫–∏

**–ê–¥–∞–ø—Ç–∏—Ä–æ–≤–∞—Ç—å:**
- `cases_service.py` ‚Üí –Ω–æ–≤—ã–π —Ñ–æ—Ä–º–∞—Ç –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ (`build_map_context` / `build_target_context`)
- `chat_service.py` ‚Üí –∞–Ω–∞–ª–æ–≥–∏—á–Ω–æ

**–£–¥–∞–ª–∏—Ç—å:**
- `json_parser.py`, `docx_parser.py` (–±–æ–ª—å—à–µ –Ω–µ –Ω—É–∂–Ω—ã)
- `/api/upload` endpoint

---

## –ú–µ—Ç—Ä–∏–∫–∏ —É—Å–ø–µ—Ö–∞ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã

- [ ] –í—Å–µ 7 –∫–µ–π—Å–æ–≤ —É—Å–ø–µ—à–Ω–æ –≤—ã–ø–æ–ª–Ω—è—é—Ç—Å—è —Å –Ω–æ–≤—ã–º —Ñ–æ—Ä–º–∞—Ç–æ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
- [ ] –ö–µ–π—Å—ã 1-4, 6 –¥–æ—Å—Ç—É–ø–Ω—ã —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –≤—ã–±–æ—Ä–µ —Ü–µ–ª–∏
- [ ] –ö–µ–π—Å—ã 5, 7 –¥–æ—Å—Ç—É–ø–Ω—ã –ø—Ä–∏ –≤—ã–±–æ—Ä–µ –∫–∞—Ä—Ç—ã
- [ ] –§–∏–ª—å—Ç—Ä –ø–µ—Ä–∏–æ–¥–∞ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ —Ñ–∏–ª—å—Ç—Ä—É–µ—Ç —Å–ø–∏—Å–æ–∫ –∫–∞—Ä—Ç
- [ ] –î–∞–Ω–Ω—ã–µ –∏–∑ Targets API –∫—ç—à–∏—Ä—É—é—Ç—Å—è –Ω–∞ —Å–µ—Å—Å–∏—é (–ø—Ä–æ–≤–µ—Ä–∫–∞ —á–µ—Ä–µ–∑ –ª–æ–≥–∏ ‚Äî –Ω–µ—Ç –ø–æ–≤—Ç–æ—Ä–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤)
- [ ] `normalize_text()` –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç escape-–ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
- [ ] `estimate_tokens()` –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –æ—Ü–µ–Ω–∏–≤–∞–µ—Ç —Ä–∞–∑–º–µ—Ä –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ (¬±10%)
- [ ] –û—à–∏–±–∫–∏ API (401, 403, 500, timeout) –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è —Å –ø–æ–Ω—è—Ç–Ω—ã–º–∏ —Å–æ–æ–±—â–µ–Ω–∏—è–º–∏
- [ ] –ë—ç–∫-–æ—Ñ–∏—Å –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç `top_maps`, `top_targets`
- [ ] Production Docker-–æ–±—Ä–∞–∑ –ù–ï —Å–æ–¥–µ—Ä–∂–∏—Ç Playwright (–ø—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–∑–º–µ—Ä–∞ <500 MB)
- [ ] E2E-—Ç–µ—Å—Ç—ã –ø—Ä–æ—Ö–æ–¥—è—Ç –ø—Ä–æ—Ç–∏–≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ —Å–Ω–∞—Ä—É–∂–∏
- [ ] Coverage ‚â•70%
- [ ] UI –∞–¥–∞–ø—Ç–∏—Ä–æ–≤–∞–Ω –ø–æ–¥ –¥–≤—É—Ö–∫–æ–ª–æ–Ω–æ—á–Ω—ã–π layout (–ª–µ–≤–∞—è –ø–∞–Ω–µ–ª—å + –æ—Å–Ω–æ–≤–Ω–∞—è –æ–±–ª–∞—Å—Ç—å)
- [ ] –ö–Ω–æ–ø–∫–∞ "–ù–æ–≤–∞—è –±–µ—Å–µ–¥–∞" —Å–±—Ä–∞—Å—ã–≤–∞–µ—Ç –∏—Å—Ç–æ—Ä–∏—é, —Å–æ—Ö—Ä–∞–Ω—è—è –∫–æ–Ω—Ç–µ–∫—Å—Ç
- [ ] Chart.js –ø–æ–¥–∫–ª—é—á—ë–Ω –ª–æ–∫–∞–ª—å–Ω–æ, —Ä–∞–±–æ—Ç–∞–µ—Ç –±–µ–∑ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–∞

---

## –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

**–ì–æ—Ç–æ–≤–æ –∫ –ø–µ—Ä–µ–¥–∞—á–µ Developer-–∞–≥–µ–Ω—Ç—É:**

‚úÖ –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —Å–ø—Ä–æ–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω–∞
‚úÖ API endpoints –æ–ø—Ä–µ–¥–µ–ª–µ–Ω—ã
‚úÖ –°—Ö–µ–º–∞ –ë–î –æ–±–Ω–æ–≤–ª–µ–Ω–∞
‚úÖ UI layout —Å–ø—Ä–æ–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω
‚úÖ –ü–ª–∞–Ω —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏ —Å–æ—Å—Ç–∞–≤–ª–µ–Ω
‚úÖ –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–∞–≤–∏–ª–∞ –∑–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω—ã

**–ü–µ—Ä–µ–¥–∞—Ç—å Developer-–∞–≥–µ–Ω—Ç—É:**
1. –≠—Ç–æ—Ç —Ñ–∞–π–ª (`.hypothesis/v2_02_ARCHITECTURE.md`)
2. –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è (`.hypothesis/v2_01_REQUIREMENTS.md`)
3. –ü—Ä–∏–º–µ—Ä—ã API (`.hypothesis/new_hypothesis/*.json`)
4. –°—É—â–µ—Å—Ç–≤—É—é—â–∏–π –∫–æ–¥ v1 (`src/`, `tests/`)

**Developer-–∞–≥–µ–Ω—Ç:** –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –ø–æ –ø–ª–∞–Ω—É —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏ (–≠—Ç–∞–ø—ã 1-7), —Å–æ–∑–¥–∞—Ç—å `04_IMPLEMENTATION.md`.

---

**–ö–æ–Ω–µ—Ü –¥–æ–∫—É–º–µ–Ω—Ç–∞ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã v2.**
