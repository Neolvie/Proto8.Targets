# –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è ‚Äî Directum Targets AI Assistant

**–í–µ—Ä—Å–∏—è:** 2.0 (v2)
**–î–∞—Ç–∞:** 2026-02-19
**–°—Ç–∞—Ç—É—Å:** –ß–µ—Ä–Ω–æ–≤–∏–∫ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã (Developer –¥–æ–ø–æ–ª–Ω–∏—Ç –ø—Ä–∏ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏)

---

## –û–±–∑–æ—Ä

**Directum Targets AI Assistant v2** ‚Äî –≤–µ–±-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –¥–ª—è –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç—É–∞–ª—å–Ω–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞ —Ü–µ–ª–µ–π –∏ –∫–ª—é—á–µ–≤—ã—Ö —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ (OKR) –∏–∑ —Å–∏—Å—Ç–µ–º—ã Directum Targets —Å –ø–æ–º–æ—â—å—é –≥–µ–Ω–µ—Ä–∞—Ç–∏–≤–Ω–æ–≥–æ –ò–ò.

### –ö–ª—é—á–µ–≤—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏

- **–ü—Ä—è–º–∞—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å Directum Targets API** (–Ω–æ–≤–æ–µ –≤ v2)
- **7 —Å–ø–µ—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –∫–µ–π—Å–æ–≤ OKR-–∞–Ω–∞–ª–∏–∑–∞** (–ø–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω—ã –∏–∑ v1)
- **–ê–¥–∞–ø—Ç–∏–≤–Ω—ã–π UI** ‚Äî –∫–µ–π—Å—ã –ø–µ—Ä–µ–∫–ª—é—á–∞—é—Ç—Å—è –º–µ–∂–¥—É —Ä–µ–∂–∏–º–∞–º–∏ ¬´–ö–∞—Ä—Ç–∞¬ª –∏ ¬´–¶–µ–ª—å¬ª (–Ω–æ–≤–æ–µ –≤ v2)
- **–õ–µ–≤–∞—è –ø–∞–Ω–µ–ª—å –Ω–∞–≤–∏–≥–∞—Ü–∏–∏** ‚Äî —Ñ–∏–ª—å—Ç—Ä –ø–µ—Ä–∏–æ–¥–∞ ‚Üí —Å–ø–∏—Å–æ–∫ –∫–∞—Ä—Ç ‚Üí —Å–ø–∏—Å–æ–∫ —Ü–µ–ª–µ–π (–Ω–æ–≤–æ–µ –≤ v2)
- **–°–≤–æ–±–æ–¥–Ω—ã–π —á–∞—Ç —Å –ò–ò** –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ –∫–∞—Ä—Ç—ã/—Ü–µ–ª–∏
- **–ë—ç–∫-–æ—Ñ–∏—Å —Å –º–µ—Ç—Ä–∏–∫–∞–º–∏** ‚Äî —Ç–æ–ø-5 –∫–∞—Ä—Ç/—Ü–µ–ª–µ–π, –æ—Ü–µ–Ω–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
- **SSE —Å—Ç—Ä–∏–º–∏–Ω–≥** ‚Äî –æ—Ç–≤–µ—Ç—ã –ò–ò –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏

### –ò–∑–º–µ–Ω–µ–Ω–∏—è v1 ‚Üí v2

| –ê—Å–ø–µ–∫—Ç | v1 | v2 |
|--------|----|----|
| –ò—Å—Ç–æ—á–Ω–∏–∫ –¥–∞–Ω–Ω—ã—Ö | –ó–∞–≥—Ä—É–∑–∫–∞ JSON/DOCX —á–µ—Ä–µ–∑ UI | API-–∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å Directum Targets |
| –ù–∞–≤–∏–≥–∞—Ü–∏—è | Dropdown —Å —Ü–µ–ª—è–º–∏ | –õ–µ–≤–∞—è –ø–∞–Ω–µ–ª—å: –ø–µ—Ä–∏–æ–¥ ‚Üí –∫–∞—Ä—Ç–∞ ‚Üí —Ü–µ–ª—å |
| –ö–µ–π—Å—ã | –í—Å–µ 7 –¥–æ—Å—Ç—É–ø–Ω—ã –≤—Å–µ–≥–¥–∞ | –ê–¥–∞–ø—Ç–∏–≤–Ω—ã–µ: 5,7 –¥–ª—è –∫–∞—Ä—Ç—ã; 1-4,6 –¥–ª—è —Ü–µ–ª–∏ |
| –ö–æ–Ω—Ç–µ–∫—Å—Ç –¥–ª—è LLM | –°—ã—Ä–æ–π JSON | –ö–æ–º–ø–∞–∫—Ç–Ω—ã–π —Ç–µ–∫—Å—Ç–æ–≤—ã–π —Ñ–æ—Ä–º–∞—Ç |
| –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ | –ù–µ—Ç | Session-based in-memory |

---

## –¢–µ—Ö–Ω–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–π —Å—Ç–µ–∫

### Backend

- **Python:** 3.10+
- **Web Framework:** FastAPI 0.115+
- **HTTP-–∫–ª–∏–µ–Ω—Ç:** httpx (async)
- **–í–∞–ª–∏–¥–∞—Ü–∏—è:** pydantic v2
- **LLM API:** OpenAI Python SDK
- **–¢–æ–∫–µ–Ω–∏–∑–∞—Ü–∏—è:** tiktoken
- **–ë–î –º–µ—Ç—Ä–∏–∫:** SQLite

### Frontend

- **Vanilla JavaScript** (–±–µ–∑ —Ñ—Ä–µ–π–º–≤–æ—Ä–∫–æ–≤)
- **HTML5 + CSS3**
- **Markdown:** –°–æ–±—Å—Ç–≤–µ–Ω–Ω—ã–π –ø–æ—Å—Ç—Ä–æ—á–Ω—ã–π –ø–∞—Ä—Å–µ—Ä
- **Charts:** Chart.js (–ª–æ–∫–∞–ª—å–Ω–∞—è –∫–æ–ø–∏—è)

### –ò–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞

- **Docker + docker-compose**
- **Multi-stage Dockerfile** (production / test)

---

## –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

–î–µ—Ç–∞–ª—å–Ω–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞: `.hypothesis/v2_02_ARCHITECTURE.md`

### –°—Ö–µ–º–∞ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤

```
Browser ‚Üí FastAPI (main.py)
            ‚îú‚îÄ targets_api.py ‚Üí Directum Targets API
            ‚îú‚îÄ context_builder.py ‚Üí –ö–æ–º–ø–∞–∫—Ç–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç
            ‚îú‚îÄ cases_service.py ‚Üí 7 –∫–µ–π—Å–æ–≤
            ‚îú‚îÄ chat_service.py ‚Üí –°–≤–æ–±–æ–¥–Ω—ã–π —á–∞—Ç
            ‚îú‚îÄ llm_service.py ‚Üí OpenAI API
            ‚îú‚îÄ metrics_storage.py ‚Üí SQLite
            ‚îî‚îÄ app.state.cache ‚Üí In-memory session cache
```

---

## –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã

| –ú–æ–¥—É–ª—å | –ü—É—Ç—å | –û–ø–∏—Å–∞–Ω–∏–µ | –°—Ç–∞—Ç—É—Å |
|--------|------|----------|--------|
| FastAPI app | `src/main.py` | –†–æ—É—Ç–µ—Ä, SSE endpoints | –ú–æ–¥–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω –¥–ª—è v2 |
| –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è | `src/config.py` | .env (–¥–æ–±–∞–≤–ª–µ–Ω—ã TARGETS_*) | –†–∞—Å—à–∏—Ä–µ–Ω –¥–ª—è v2 |
| Targets API | `src/services/targets_api.py` | HTTP-–∫–ª–∏–µ–Ω—Ç –∫ Directum Targets | NEW –≤ v2 |
| Context Builder | `src/services/context_builder.py` | –ö–æ–º–ø–∞–∫—Ç–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –¥–ª—è LLM | NEW –≤ v2 |
| LLM —Å–µ—Ä–≤–∏—Å | `src/services/llm_service.py` | OpenAI SDK streaming | –ü–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω as-is |
| –ö–µ–π—Å—ã | `src/services/cases_service.py` | 7 OKR-–∫–µ–π—Å–æ–≤ | –ê–¥–∞–ø—Ç–∏—Ä–æ–≤–∞–Ω –¥–ª—è v2 |
| –ß–∞—Ç | `src/services/chat_service.py` | –°–≤–æ–±–æ–¥–Ω—ã–π —á–∞—Ç | –ê–¥–∞–ø—Ç–∏—Ä–æ–≤–∞–Ω –¥–ª—è v2 |
| –ú–µ—Ç—Ä–∏–∫–∏ | `src/services/metrics_storage.py` | SQLite (–¥–æ–±–∞–≤–ª–µ–Ω—ã top_maps/targets) | –†–∞—Å—à–∏—Ä–µ–Ω –¥–ª—è v2 |
| Pydantic –º–æ–¥–µ–ª–∏ | `src/models/targets.py` | –ú–æ–¥–µ–ª–∏ Targets API | NEW –≤ v2 |
| –ì–ª–∞–≤–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ | `src/static/index.html` | UI: –Ω–∞–≤–∏–≥–∞—Ü–∏—è + –∫–µ–π—Å—ã | –ú–æ–¥–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω –¥–ª—è v2 |
| JS –ª–æ–≥–∏–∫–∞ | `src/static/app.js` | –ù–∞–≤–∏–≥–∞—Ü–∏—è, –∫—ç—à, SSE | –ú–æ–¥–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω –¥–ª—è v2 |
| –°—Ç–∏–ª–∏ | `src/static/style.css` | –î–≤—É—Ö–∫–æ–ª–æ–Ω–æ—á–Ω—ã–π layout | –†–∞—Å—à–∏—Ä–µ–Ω –¥–ª—è v2 |
| –ë—ç–∫-–æ—Ñ–∏—Å | `src/static/backoffice.html` | –ú–µ—Ç—Ä–∏–∫–∏ | –†–∞—Å—à–∏—Ä–µ–Ω –¥–ª—è v2 |

**–£–¥–∞–ª–µ–Ω–æ –∏–∑ v1:**
- `src/services/json_parser.py` (–∑–∞–º–µ–Ω—ë–Ω –Ω–∞ targets_api.py)
- `src/services/docx_parser.py` (–±–æ–ª—å—à–µ –Ω–µ –Ω—É–∂–µ–Ω)

---

## API Endpoints

### v2 Endpoints

| –ú–µ—Ç–æ–¥ | –ü—É—Ç—å | –û–ø–∏—Å–∞–Ω–∏–µ |
|-------|------|----------|
| GET | / | –ì–ª–∞–≤–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ (index.html) |
| GET | /backoffice | –°—Ç—Ä–∞–Ω–∏—Ü–∞ –º–µ—Ç—Ä–∏–∫ (backoffice.html) |
| GET | /api/health | Healthcheck |
| **GET** | **/api/maps** | **–°–ø–∏—Å–æ–∫ –∫–∞—Ä—Ç —Ü–µ–ª–µ–π (—Å —Ñ–∏–ª—å—Ç—Ä–æ–º –ø–µ—Ä–∏–æ–¥–∞)** |
| **GET** | **/api/maps/{map_id}/goals** | **–ì—Ä–∞—Ñ —Ü–µ–ª–µ–π –∫–∞—Ä—Ç—ã** |
| **GET** | **/api/targets/{target_id}** | **–†–∞—Å—à–∏—Ä–µ–Ω–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –ø–æ —Ü–µ–ª–∏ + –ö–†** |
| POST | /api/cases/{case_id} | –ó–∞–ø—É—Å–∫ –∫–µ–π—Å–∞ 1-7 (SSE) |
| POST | /api/chat | –°–≤–æ–±–æ–¥–Ω—ã–π —á–∞—Ç (SSE) |
| POST | /api/feedback | –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –æ—Ü–µ–Ω–∫–∏ üëç/üëé |
| GET | /api/metrics | –ú–µ—Ç—Ä–∏–∫–∏ –¥–ª—è –±—ç–∫-–æ—Ñ–∏—Å–∞ |

**–£–¥–∞–ª–µ–Ω—ã –∏–∑ v1:**
- ~~GET /api/data/test~~ (–±–æ–ª—å—à–µ –Ω–µ—Ç –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–æ–≤)
- ~~POST /api/data/upload~~ (–±–æ–ª—å—à–µ –Ω–µ—Ç –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–æ–≤)

### –ü—Ä–∏–º–µ—Ä –∑–∞–ø—Ä–æ—Å–∞: GET /api/maps

**Request:**
```http
GET /api/maps?period=2026
X-Session-Id: sess_1735123456_abc123
```

**Response:**
```json
{
  "maps": [
    {
      "id": 15,
      "name": "–¶–µ–ª–∏ –Ω–∞ 2026. –†–∞–∑—Ä–∞–±–æ—Ç–∫–∞ Ario",
      "code": "U-26.4",
      "period_label": "2026",
      "achievement_percentage": 31.0,
      "status": "Active"
    }
  ],
  "periods": ["2026", "1 –∫–≤–∞—Ä—Ç–∞–ª 2026", "4 –∫–≤–∞—Ä—Ç–∞–ª 2025"]
}
```

### –ü—Ä–∏–º–µ—Ä –∑–∞–ø—Ä–æ—Å–∞: POST /api/cases/1

**Request:**
```http
POST /api/cases/1
Content-Type: application/json
X-Session-Id: sess_1735123456_abc123

{
  "mode": "target",
  "map_id": 15,
  "target_id": 97,
  "session_id": "sess_1735123456_abc123"
}
```

**Response (SSE stream):**
```
data: "–ê–Ω–∞–ª–∏–∑ —Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∫–∏ —Ü–µ–ª–∏...\n\n"

data: "## SMART-–∞–Ω–∞–ª–∏–∑\n\n"

data: "- **S (Specific):** –¶–µ–ª—å —Å—Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∞–Ω–∞ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ...\n\n"

data: [DONE]
```

---

## –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å Directum Targets API

### Endpoints Directum Targets

1. **–°–ø–∏—Å–æ–∫ –∫–∞—Ä—Ç:**
   ```
   GET {TARGETS_BASE_URL}/Integration/odata/ITargetsTargetsMaps
   Authorization: Bearer {TARGETS_TOKEN}
   ```

2. **–ì—Ä–∞—Ñ —Ü–µ–ª–µ–π –∫–∞—Ä—Ç—ã:**
   ```
   POST {TARGETS_BASE_URL}/integration/odata/Targets/GetGoalsMap
   Body: {"mapId": 15}
   ```

3. **–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –ø–æ —Ü–µ–ª–∏:**
   ```
   GET {TARGETS_BASE_URL}/Integration/odata/ITargetsTargets(97)
   ```

4. **–ö–ª—é—á–µ–≤—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã:**
   ```
   GET {TARGETS_BASE_URL}/integration/odata/Targets/GetKeyResults(targetId=97)
   ```

### –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫

| –ö–æ–¥ | –û–±—Ä–∞–±–æ—Ç–∫–∞ |
|-----|-----------|
| 401 | "Bearer-—Ç–æ–∫–µ–Ω –∏—Å—Ç—ë–∫. –û–±–Ω–æ–≤–∏—Ç–µ TARGETS_TOKEN –≤ .env" |
| 403 | "–î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â—ë–Ω. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø—Ä–∞–≤–∞ —Ç–æ–∫–µ–Ω–∞" |
| 404 | "–ö–∞—Ä—Ç–∞/—Ü–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω–∞" |
| 500 | "–û—à–∏–±–∫–∞ API Targets: {details}" |
| Timeout | "–¢–∞–π–º–∞—É—Ç API Targets. –ü–æ–≤—Ç–æ—Ä–∏—Ç–µ –∑–∞–ø—Ä–æ—Å" |

---

## –§–æ—Ä–º–∞—Ç –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –¥–ª—è LLM

### –ö–æ–Ω—Ç–µ–∫—Å—Ç –∫–∞—Ä—Ç—ã (—Ä–µ–∂–∏–º ¬´–ö–∞—Ä—Ç–∞¬ª)

–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –∫–µ–π—Å–æ–≤ 5, 7.

**–§–æ—Ä–º–∞—Ç (–∫–æ–º–ø–∞–∫—Ç–Ω—ã–π —Ç–µ–∫—Å—Ç):**

```
–ö–∞—Ä—Ç–∞ —Ü–µ–ª–µ–π: {Name} | –ü–µ—Ä–∏–æ–¥: {PeriodLabel} | –ü—Ä–æ–≥—Ä–µ—Å—Å: {AchievementPercentage}%

[{Code}] {Name}
  –û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π: {Responsible.Name} | –ü–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ: {StructuralUnit.Name}
  –ü–µ—Ä–∏–æ–¥: {Period.Name} | –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç: {Priority} | –ü—Ä–æ–≥—Ä–µ—Å—Å: {Progress}% | –ö–†: {KeyResultCount}
  –°—Ç–∞—Ç—É—Å: {Status.Name} {Status.Icon}
  –î–æ—á–µ—Ä–Ω–∏–µ: {ChildIds -> Code, Name}
  –û—Ç—á—ë—Ç ({ReportDate}): {LastAchievementStatus.Description}
---
```

**–†–∞–∑–º–µ—Ä:**
- 20 —Ü–µ–ª–µ–π ‚Üí ~15 KB ‚Üí ~4k —Ç–æ–∫–µ–Ω–æ–≤
- 100 —Ü–µ–ª–µ–π ‚Üí ~80 KB ‚Üí ~20k —Ç–æ–∫–µ–Ω–æ–≤
- 300 —Ü–µ–ª–µ–π ‚Üí ~250 KB ‚Üí ~65k —Ç–æ–∫–µ–Ω–æ–≤

### –ö–æ–Ω—Ç–µ–∫—Å—Ç —Ü–µ–ª–∏ (—Ä–µ–∂–∏–º ¬´–¶–µ–ª—å¬ª)

–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –∫–µ–π—Å–æ–≤ 1-4, 6.

**–§–æ—Ä–º–∞—Ç:**

```
–¶–µ–ª—å: [{Code}] {Name}
–ü–µ—Ä–∏–æ–¥: {PeriodLabel} ({PeriodStart} ‚Äî {PeriodEnd})
–°—Ç–∞—Ç—É—Å: {StatusDescription} | –ü—Ä–æ–≥—Ä–µ—Å—Å: {AchievementPercentage}% | –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç: {Priority}

–û–ø–∏—Å–∞–Ω–∏–µ:
{Description}

–ó–∞–º–µ—Ç–∫–∏ —Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤–∞:
{Notes}

–ö–ª—é—á–µ–≤—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã:
- {Description}: {AchievementPercentage}%
  (–ú–µ—Ç—Ä–∏–∫–∞: {Metric} | –ù–∞—á: {InitialValue} | –ü–ª–∞–Ω: {PlannedValue} | –§–∞–∫—Ç: {ActualValue})
```

### –ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è —Ç–µ–∫—Å—Ç–∞

`normalize_text()` —É–¥–∞–ª—è–µ—Ç escape-–ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç–∏:
- `\\n` ‚Üí `\n` (—Ä–µ–∞–ª—å–Ω—ã–π –ø–µ—Ä–µ–Ω–æ—Å)
- `\\\\` ‚Üí `\` (–æ–¥–∏–Ω–∞—Ä–Ω—ã–π —Å–ª–µ—à)
- `\\r` ‚Üí (—É–¥–∞–ª–∏—Ç—å)

–ü—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è –∫: `Description`, `Notes`, `LastAchievementStatus.Description`

---

## –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö

### –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –∫—ç—à–∞

```python
app.state.cache = {
  "session_id": {
    "maps": List[TargetsMap],
    "map_graph": {
      map_id: MapGraph
    },
    "targets": {
      target_id: {
        "detail": TargetDetail,
        "key_results": List[KeyResult]
      }
    }
  }
}
```

### –°—Ç—Ä–∞—Ç–µ–≥–∏—è

- **–°–ø–∏—Å–æ–∫ –∫–∞—Ä—Ç:** –ö—ç—à –Ω–∞ –≤—Å—é —Å–µ—Å—Å–∏—é
- **–ì—Ä–∞—Ñ –∫–∞—Ä—Ç—ã:** –ö—ç—à –¥–æ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
- **–¶–µ–ª—å + –ö–†:** –ö—ç—à –¥–æ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞

### Session ID

–ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è –Ω–∞ —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–µ:
```js
let sid = sessionStorage.getItem('targets_session_id');
if (!sid) {
  sid = 'sess_' + Date.now() + '_' + Math.random().toString(36).slice(2);
  sessionStorage.setItem('targets_session_id', sid);
}
```

–ü–µ—Ä–µ–¥–∞—ë—Ç—Å—è –≤ –∑–∞–≥–æ–ª–æ–≤–∫–µ `X-Session-Id`.

---

## –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –º–µ—Ç—Ä–∏–∫ (SQLite)

### –°—Ö–µ–º–∞ –ë–î v2

**–¢–∞–±–ª–∏—Ü–∞ `requests`:**
```sql
CREATE TABLE requests (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    ip TEXT NOT NULL,
    endpoint TEXT NOT NULL,
    case_id INTEGER,
    map_id INTEGER,           -- NEW –≤ v2
    target_id INTEGER,        -- NEW –≤ v2
    timestamp DATETIME DEFAULT CURRENT_TIMESTAMP
);
```

**–¢–∞–±–ª–∏—Ü–∞ `feedback`:**
```sql
CREATE TABLE feedback (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    ip TEXT NOT NULL,
    case_id INTEGER NOT NULL,
    session_id TEXT NOT NULL,
    vote INTEGER NOT NULL,
    timestamp DATETIME DEFAULT CURRENT_TIMESTAMP,
    UNIQUE(case_id, session_id)
);
```

### –ù–æ–≤—ã–µ –º–µ—Ç—Ä–∏–∫–∏ v2

- `top_maps` ‚Äî —Ç–æ–ø-5 –∫–∞—Ä—Ç –ø–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤—É –æ–±—Ä–∞—â–µ–Ω–∏–π
- `top_targets` ‚Äî —Ç–æ–ø-5 —Ü–µ–ª–µ–π –ø–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤—É –æ–±—Ä–∞—â–µ–Ω–∏–π

---

## –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è

–§–∞–π–ª `.env` (—Å–æ–∑–¥–∞—ë—Ç—Å—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º –∏–∑ `.env.example`):

```dotenv
# OpenAI API
OPENAI_API_KEY=sk-...
OPENAI_MODEL=gpt-4o
OPENAI_BASE_URL=https://api.openai.com/v1

# Directum Targets API (NEW –≤ v2)
TARGETS_BASE_URL=https://aura.npo-comp.ru
TARGETS_TOKEN=your-bearer-token-here
```

**–ü—Ä–∞–≤–∏–ª–∞:**
- `.env` **–ù–ï –¢–†–û–ì–ê–¢–¨** ‚Äî –∞–≥–µ–Ω—Ç—ã –Ω–µ —Å–æ–∑–¥–∞—é—Ç –∏ –Ω–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä—É—é—Ç
- `.env.example` ‚Äî —à–∞–±–ª–æ–Ω –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

---

## –†–∞–∑–≤—ë—Ä—Ç—ã–≤–∞–Ω–∏–µ

### Docker Compose

```bash
# –ó–∞–ø—É—Å–∫ production
docker-compose up -d app

# –õ–æ–≥–∏
docker-compose logs -f app

# –û—Å—Ç–∞–Ω–æ–≤–∫–∞
docker-compose down
```

### Multi-stage Dockerfile

- **production stage:** –ë–ï–ó Playwright (–¥–ª—è production)
- **test stage:** –° Playwright (–¥–ª—è E2E-—Ç–µ—Å—Ç–æ–≤)

```bash
# Production –æ–±—Ä–∞–∑
docker build --target production -t targets-ai:prod .

# Test –æ–±—Ä–∞–∑
docker build --target test -t targets-ai:test .
```

---

## –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### Unit-—Ç–µ—Å—Ç—ã

```bash
# –õ–æ–∫–∞–ª—å–Ω–æ
pytest tests/unit/ -v --cov=src --cov-report=term

# –í Docker
docker-compose run --rm test
```

**–ù–æ–≤—ã–µ —Ç–µ—Å—Ç—ã v2:**
- `test_targets_api.py` ‚Äî —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ HTTP-–∫–ª–∏–µ–Ω—Ç–∞ —Å –º–æ–∫–∞–º–∏ httpx
- `test_context_builder.py` ‚Äî —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞

### E2E-—Ç–µ—Å—Ç—ã

**–ó–∞–ø—É—Å–∫–∞—é—Ç—Å—è –°–ù–ê–†–£–ñ–ò –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞!**

```bash
# –ó–∞–ø—É—Å—Ç–∏—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
docker-compose up -d app

# –î–æ–∂–¥–∞—Ç—å—Å—è –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏
sleep 5

# –ó–∞–ø—É—Å—Ç–∏—Ç—å E2E
pytest tests/e2e/ --headed --slowmo=100
```

**–ù–æ–≤—ã–µ E2E-—Å—Ü–µ–Ω–∞—Ä–∏–∏ v2:**
- –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –∫–∞—Ä—Ç –ø–æ –ø–µ—Ä–∏–æ–¥—É
- –í—ã–±–æ—Ä –∫–∞—Ä—Ç—ã ‚Üí –∑–∞–≥—Ä—É–∑–∫–∞ —Ü–µ–ª–µ–π
- –í—ã–±–æ—Ä —Ü–µ–ª–∏ ‚Üí –∞–¥–∞–ø—Ç–∏–≤–Ω—ã–µ –∫–µ–π—Å—ã
- –ö–Ω–æ–ø–∫–∞ "–ù–æ–≤–∞—è –±–µ—Å–µ–¥–∞"

---

## –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –ø—Ä–æ—Ç–æ—Ç–∏–ø–∞

### v1 (—É—Å—Ç—Ä–∞–Ω–µ–Ω–æ –≤ v2):
- ~~–ù–µ—Ç –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ —Å Directum Targets API~~ ‚Üí **–†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ –≤ v2**
- ~~–ó–∞–≥—Ä—É–∑–∫–∞ —Ç–æ–ª—å–∫–æ —á–µ—Ä–µ–∑ —Ñ–∞–π–ª—ã~~ ‚Üí **API-–∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –≤ v2**

### v2 (—Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ):
- –ù–µ—Ç –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ –∏ —Ä–∞–∑–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –ø—Ä–∞–≤
- –ù–µ—Ç —Ö—Ä–∞–Ω–µ–Ω–∏—è –∏—Å—Ç–æ—Ä–∏–∏ —Å–µ—Å—Å–∏–π –º–µ–∂–¥—É –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–º–∏
- –¢–æ–ª—å–∫–æ —Ä—É—Å—Å–∫–∏–π —è–∑—ã–∫ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
- –ö–æ–Ω—Ç–µ–∫—Å—Ç –æ–≥—Ä–∞–Ω–∏—á–µ–Ω 128k —Ç–æ–∫–µ–Ω–æ–≤ (gpt-4o)
- SQLite –Ω–µ –ø–æ–¥—Ö–æ–¥–∏—Ç –¥–ª—è –≤—ã—Å–æ–∫–æ–π –Ω–∞–≥—Ä—É–∑–∫–∏ (–ø—Ä–æ—Ç–æ—Ç–∏–ø)

### v2 (–Ω–æ–≤—ã–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è):
- Bearer-—Ç–æ–∫–µ–Ω —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏–π (–æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –≤—Ä—É—á–Ω—É—é —á–µ—Ä–µ–∑ `.env`)
- –ö—ç—à in-memory (—Å–±—Ä–∞—Å—ã–≤–∞–µ—Ç—Å—è –ø—Ä–∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–µ)
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ–±—Ä–µ–∑–∫–∞ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –Ω–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ (—Ç–æ–ª—å–∫–æ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ)

---

## –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–∞–≤–∏–ª–∞ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

### 1. SSE —Å—Ç—Ä–∏–º–∏–Ω–≥

**–ë—ç–∫–µ–Ω–¥:**
```python
yield f"data: {json.dumps(chunk)}\n\n"  # –ß–∞–Ω–∫ —Ü–µ–ª–∏–∫–æ–º, –ë–ï–ó split("\n")
```

### 2. Markdown

–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ø–æ—Å—Ç—Ä–æ—á–Ω—ã–π `renderMarkdown` –∏–∑ `app.js` (–ø–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∏–∑ v1).

### 3. AbortController

–ü—Ä–∏ –∑–∞–ø—É—Å–∫–µ –Ω–æ–≤–æ–≥–æ –∫–µ–π—Å–∞ –æ—Ç–º–µ–Ω—è—Ç—å –ø—Ä–µ–¥—ã–¥—É—â–∏–π:
```js
if (state.caseAbortController) state.caseAbortController.abort();
```

### 4. –õ–æ–∫–∞–ª—å–Ω—ã–µ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏

–í—Å–µ JS-–±–∏–±–ª–∏–æ—Ç–µ–∫–∏ (Chart.js) ‚Äî –ª–æ–∫–∞–ª—å–Ω–æ –≤ `src/static/`, –ù–ï —á–µ—Ä–µ–∑ CDN.

### 5. Multi-stage Dockerfile

Production –æ–±—Ä–∞–∑ –ë–ï–ó Playwright. E2E-—Ç–µ—Å—Ç—ã –∑–∞–ø—É—Å–∫–∞—é—Ç—Å—è —Å–Ω–∞—Ä—É–∂–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞.

### 6. .env –Ω–µ —Ç—Ä–æ–≥–∞—Ç—å

–ê–≥–µ–Ω—Ç—ã –ù–ï —Å–æ–∑–¥–∞—é—Ç –∏ –ù–ï —Ä–µ–¥–∞–∫—Ç–∏—Ä—É—é—Ç `.env`. –¢–æ–ª—å–∫–æ `.env.example`.

---

## –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

**Architect ‚Üí Developer:**

Architect —Å–æ–∑–¥–∞–ª:
- ‚úÖ `.hypothesis/v2_02_ARCHITECTURE.md` ‚Äî –¥–µ—Ç–∞–ª—å–Ω–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ v2
- ‚úÖ `TECHNICAL_DOCUMENTATION.md` ‚Äî —ç—Ç–æ—Ç —Ñ–∞–π–ª (—Å–∫–µ–ª–µ—Ç –¥–ª—è Developer)

Developer –¥–æ–ª–∂–µ–Ω:
1. –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –ø–æ –ø–ª–∞–Ω—É —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏ –∏–∑ `v2_02_ARCHITECTURE.md`
2. –î–æ–ø–æ–ª–Ω–∏—Ç—å —ç—Ç–æ—Ç —Ñ–∞–π–ª –ø—Ä–∏–º–µ—Ä–∞–º–∏ API-–∑–∞–ø—Ä–æ—Å–æ–≤, —Å—Ö–µ–º–∞–º–∏ –¥–∞–Ω–Ω—ã—Ö
3. –°–æ–∑–¥–∞—Ç—å `.hypothesis/v2_04_IMPLEMENTATION.md`

---

**–ö–æ–Ω–µ—Ü —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–æ–π –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏ v2 (—á–µ—Ä–Ω–æ–≤–∏–∫ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã).**

_Developer –¥–æ–ø–æ–ª–Ω–∏—Ç –ø—Ä–∏ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏._
